{"mappings":"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","sources":["node_modules/webrtc-adapter/src/js/utils.js","node_modules/webrtc-adapter/src/js/chrome/chrome_shim.js","node_modules/webrtc-adapter/src/js/chrome/getusermedia.js","node_modules/webrtc-adapter/src/js/edge/edge_shim.js","node_modules/sdp/sdp.js","node_modules/webrtc-adapter/src/js/edge/getusermedia.js","node_modules/webrtc-adapter/src/js/firefox/firefox_shim.js","node_modules/webrtc-adapter/src/js/firefox/getusermedia.js","node_modules/webrtc-adapter/src/js/safari/safari_shim.js","node_modules/webrtc-adapter/src/js/adapter_core.js","node_modules/getusermedia/getusermedia.js","node_modules/@epok.tech/gl-screen-triangle/index.js","node_modules/@epok.tech/fn-lists/range.js","node_modules/@epok.tech/fn-lists/reduce.js","node_modules/@epok.tech/fn-lists/map.js","node_modules/@epok.tech/fn-lists/each.js","node_modules/@epok.tech/fn-lists/wrap-index.js","index.frag.glsl","demo/spread.frag.glsl","demo/view.frag.glsl","demo/index.js","node_modules/@epok.tech/gl-screen-triangle/uv-texture.vert.glsl"],"sourcesContent":["/*\n *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.\n *\n *  Use of this source code is governed by a BSD-style license\n *  that can be found in the LICENSE file in the root of the source\n *  tree.\n */\n /* eslint-env node */\n'use strict';\n\nvar logDisabled_ = true;\n\n// Utility methods.\nvar utils = {\n  disableLog: function(bool) {\n    if (typeof bool !== 'boolean') {\n      return new Error('Argument type: ' + typeof bool +\n          '. Please use a boolean.');\n    }\n    logDisabled_ = bool;\n    return (bool) ? 'adapter.js logging disabled' :\n        'adapter.js logging enabled';\n  },\n\n  log: function() {\n    if (typeof window === 'object') {\n      if (logDisabled_) {\n        return;\n      }\n      if (typeof console !== 'undefined' && typeof console.log === 'function') {\n        console.log.apply(console, arguments);\n      }\n    }\n  },\n\n  /**\n   * Extract browser version out of the provided user agent string.\n   *\n   * @param {!string} uastring userAgent string.\n   * @param {!string} expr Regular expression used as match criteria.\n   * @param {!number} pos position in the version string to be returned.\n   * @return {!number} browser version.\n   */\n  extractVersion: function(uastring, expr, pos) {\n    var match = uastring.match(expr);\n    return match && match.length >= pos && parseInt(match[pos], 10);\n  },\n\n  /**\n   * Browser detector.\n   *\n   * @return {object} result containing browser and version\n   *     properties.\n   */\n  detectBrowser: function() {\n    // Returned result object.\n    var result = {};\n    result.browser = null;\n    result.version = null;\n\n    // Fail early if it's not a browser\n    if (typeof window === 'undefined' || !window.navigator) {\n      result.browser = 'Not a browser.';\n      return result;\n    }\n\n    // Firefox.\n    if (navigator.mozGetUserMedia) {\n      result.browser = 'firefox';\n      result.version = this.extractVersion(navigator.userAgent,\n          /Firefox\\/([0-9]+)\\./, 1);\n\n    // all webkit-based browsers\n    } else if (navigator.webkitGetUserMedia) {\n      // Chrome, Chromium, Webview, Opera, all use the chrome shim for now\n      if (window.webkitRTCPeerConnection) {\n        result.browser = 'chrome';\n        result.version = this.extractVersion(navigator.userAgent,\n          /Chrom(e|ium)\\/([0-9]+)\\./, 2);\n\n      // Safari or unknown webkit-based\n      // for the time being Safari has support for MediaStreams but not webRTC\n      } else {\n        // Safari UA substrings of interest for reference:\n        // - webkit version:           AppleWebKit/602.1.25 (also used in Op,Cr)\n        // - safari UI version:        Version/9.0.3 (unique to Safari)\n        // - safari UI webkit version: Safari/601.4.4 (also used in Op,Cr)\n        //\n        // if the webkit version and safari UI webkit versions are equals,\n        // ... this is a stable version.\n        //\n        // only the internal webkit version is important today to know if\n        // media streams are supported\n        //\n        if (navigator.userAgent.match(/Version\\/(\\d+).(\\d+)/)) {\n          result.browser = 'safari';\n          result.version = this.extractVersion(navigator.userAgent,\n            /AppleWebKit\\/([0-9]+)\\./, 1);\n\n        // unknown webkit-based browser\n        } else {\n          result.browser = 'Unsupported webkit-based browser ' +\n              'with GUM support but no WebRTC support.';\n          return result;\n        }\n      }\n\n    // Edge.\n    } else if (navigator.mediaDevices &&\n        navigator.userAgent.match(/Edge\\/(\\d+).(\\d+)$/)) {\n      result.browser = 'edge';\n      result.version = this.extractVersion(navigator.userAgent,\n          /Edge\\/(\\d+).(\\d+)$/, 2);\n\n    // Default fallthrough: not supported.\n    } else {\n      result.browser = 'Not a supported browser.';\n      return result;\n    }\n\n    return result;\n  }\n};\n\n// Export.\nmodule.exports = {\n  log: utils.log,\n  disableLog: utils.disableLog,\n  browserDetails: utils.detectBrowser(),\n  extractVersion: utils.extractVersion\n};\n","\n/*\n *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.\n *\n *  Use of this source code is governed by a BSD-style license\n *  that can be found in the LICENSE file in the root of the source\n *  tree.\n */\n /* eslint-env node */\n'use strict';\nvar logging = require('../utils.js').log;\nvar browserDetails = require('../utils.js').browserDetails;\n\nvar chromeShim = {\n  shimMediaStream: function() {\n    window.MediaStream = window.MediaStream || window.webkitMediaStream;\n  },\n\n  shimOnTrack: function() {\n    if (typeof window === 'object' && window.RTCPeerConnection && !('ontrack' in\n        window.RTCPeerConnection.prototype)) {\n      Object.defineProperty(window.RTCPeerConnection.prototype, 'ontrack', {\n        get: function() {\n          return this._ontrack;\n        },\n        set: function(f) {\n          var self = this;\n          if (this._ontrack) {\n            this.removeEventListener('track', this._ontrack);\n            this.removeEventListener('addstream', this._ontrackpoly);\n          }\n          this.addEventListener('track', this._ontrack = f);\n          this.addEventListener('addstream', this._ontrackpoly = function(e) {\n            // onaddstream does not fire when a track is added to an existing\n            // stream. But stream.onaddtrack is implemented so we use that.\n            e.stream.addEventListener('addtrack', function(te) {\n              var event = new Event('track');\n              event.track = te.track;\n              event.receiver = {track: te.track};\n              event.streams = [e.stream];\n              self.dispatchEvent(event);\n            });\n            e.stream.getTracks().forEach(function(track) {\n              var event = new Event('track');\n              event.track = track;\n              event.receiver = {track: track};\n              event.streams = [e.stream];\n              this.dispatchEvent(event);\n            }.bind(this));\n          }.bind(this));\n        }\n      });\n    }\n  },\n\n  shimSourceObject: function() {\n    if (typeof window === 'object') {\n      if (window.HTMLMediaElement &&\n        !('srcObject' in window.HTMLMediaElement.prototype)) {\n        // Shim the srcObject property, once, when HTMLMediaElement is found.\n        Object.defineProperty(window.HTMLMediaElement.prototype, 'srcObject', {\n          get: function() {\n            return this._srcObject;\n          },\n          set: function(stream) {\n            var self = this;\n            // Use _srcObject as a private property for this shim\n            this._srcObject = stream;\n            if (this.src) {\n              URL.revokeObjectURL(this.src);\n            }\n\n            if (!stream) {\n              this.src = '';\n              return;\n            }\n            this.src = URL.createObjectURL(stream);\n            // We need to recreate the blob url when a track is added or\n            // removed. Doing it manually since we want to avoid a recursion.\n            stream.addEventListener('addtrack', function() {\n              if (self.src) {\n                URL.revokeObjectURL(self.src);\n              }\n              self.src = URL.createObjectURL(stream);\n            });\n            stream.addEventListener('removetrack', function() {\n              if (self.src) {\n                URL.revokeObjectURL(self.src);\n              }\n              self.src = URL.createObjectURL(stream);\n            });\n          }\n        });\n      }\n    }\n  },\n\n  shimPeerConnection: function() {\n    // The RTCPeerConnection object.\n    window.RTCPeerConnection = function(pcConfig, pcConstraints) {\n      // Translate iceTransportPolicy to iceTransports,\n      // see https://code.google.com/p/webrtc/issues/detail?id=4869\n      logging('PeerConnection');\n      if (pcConfig && pcConfig.iceTransportPolicy) {\n        pcConfig.iceTransports = pcConfig.iceTransportPolicy;\n      }\n\n      var pc = new webkitRTCPeerConnection(pcConfig, pcConstraints);\n      var origGetStats = pc.getStats.bind(pc);\n      pc.getStats = function(selector, successCallback, errorCallback) {\n        var self = this;\n        var args = arguments;\n\n        // If selector is a function then we are in the old style stats so just\n        // pass back the original getStats format to avoid breaking old users.\n        if (arguments.length > 0 && typeof selector === 'function') {\n          return origGetStats(selector, successCallback);\n        }\n\n        var fixChromeStats_ = function(response) {\n          var standardReport = {};\n          var reports = response.result();\n          reports.forEach(function(report) {\n            var standardStats = {\n              id: report.id,\n              timestamp: report.timestamp,\n              type: report.type\n            };\n            report.names().forEach(function(name) {\n              standardStats[name] = report.stat(name);\n            });\n            standardReport[standardStats.id] = standardStats;\n          });\n\n          return standardReport;\n        };\n\n        // shim getStats with maplike support\n        var makeMapStats = function(stats, legacyStats) {\n          var map = new Map(Object.keys(stats).map(function(key) {\n            return[key, stats[key]];\n          }));\n          legacyStats = legacyStats || stats;\n          Object.keys(legacyStats).forEach(function(key) {\n            map[key] = legacyStats[key];\n          });\n          return map;\n        };\n\n        if (arguments.length >= 2) {\n          var successCallbackWrapper_ = function(response) {\n            args[1](makeMapStats(fixChromeStats_(response)));\n          };\n\n          return origGetStats.apply(this, [successCallbackWrapper_,\n              arguments[0]]);\n        }\n\n        // promise-support\n        return new Promise(function(resolve, reject) {\n          if (args.length === 1 && typeof selector === 'object') {\n            origGetStats.apply(self, [\n              function(response) {\n                resolve(makeMapStats(fixChromeStats_(response)));\n              }, reject]);\n          } else {\n            // Preserve legacy chrome stats only on legacy access of stats obj\n            origGetStats.apply(self, [\n              function(response) {\n                resolve(makeMapStats(fixChromeStats_(response),\n                    response.result()));\n              }, reject]);\n          }\n        }).then(successCallback, errorCallback);\n      };\n\n      return pc;\n    };\n    window.RTCPeerConnection.prototype = webkitRTCPeerConnection.prototype;\n\n    // wrap static methods. Currently just generateCertificate.\n    if (webkitRTCPeerConnection.generateCertificate) {\n      Object.defineProperty(window.RTCPeerConnection, 'generateCertificate', {\n        get: function() {\n          return webkitRTCPeerConnection.generateCertificate;\n        }\n      });\n    }\n\n    ['createOffer', 'createAnswer'].forEach(function(method) {\n      var nativeMethod = webkitRTCPeerConnection.prototype[method];\n      webkitRTCPeerConnection.prototype[method] = function() {\n        var self = this;\n        if (arguments.length < 1 || (arguments.length === 1 &&\n            typeof arguments[0] === 'object')) {\n          var opts = arguments.length === 1 ? arguments[0] : undefined;\n          return new Promise(function(resolve, reject) {\n            nativeMethod.apply(self, [resolve, reject, opts]);\n          });\n        }\n        return nativeMethod.apply(this, arguments);\n      };\n    });\n\n    // add promise support -- natively available in Chrome 51\n    if (browserDetails.version < 51) {\n      ['setLocalDescription', 'setRemoteDescription', 'addIceCandidate']\n          .forEach(function(method) {\n            var nativeMethod = webkitRTCPeerConnection.prototype[method];\n            webkitRTCPeerConnection.prototype[method] = function() {\n              var args = arguments;\n              var self = this;\n              var promise = new Promise(function(resolve, reject) {\n                nativeMethod.apply(self, [args[0], resolve, reject]);\n              });\n              if (args.length < 2) {\n                return promise;\n              }\n              return promise.then(function() {\n                args[1].apply(null, []);\n              },\n              function(err) {\n                if (args.length >= 3) {\n                  args[2].apply(null, [err]);\n                }\n              });\n            };\n          });\n    }\n\n    // shim implicit creation of RTCSessionDescription/RTCIceCandidate\n    ['setLocalDescription', 'setRemoteDescription', 'addIceCandidate']\n        .forEach(function(method) {\n          var nativeMethod = webkitRTCPeerConnection.prototype[method];\n          webkitRTCPeerConnection.prototype[method] = function() {\n            arguments[0] = new ((method === 'addIceCandidate') ?\n                RTCIceCandidate : RTCSessionDescription)(arguments[0]);\n            return nativeMethod.apply(this, arguments);\n          };\n        });\n\n    // support for addIceCandidate(null or undefined)\n    var nativeAddIceCandidate =\n        RTCPeerConnection.prototype.addIceCandidate;\n    RTCPeerConnection.prototype.addIceCandidate = function() {\n      if (!arguments[0]) {\n        if (arguments[1]) {\n          arguments[1].apply(null);\n        }\n        return Promise.resolve();\n      }\n      return nativeAddIceCandidate.apply(this, arguments);\n    };\n  }\n};\n\n\n// Expose public methods.\nmodule.exports = {\n  shimMediaStream: chromeShim.shimMediaStream,\n  shimOnTrack: chromeShim.shimOnTrack,\n  shimSourceObject: chromeShim.shimSourceObject,\n  shimPeerConnection: chromeShim.shimPeerConnection,\n  shimGetUserMedia: require('./getusermedia')\n};\n","/*\n *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.\n *\n *  Use of this source code is governed by a BSD-style license\n *  that can be found in the LICENSE file in the root of the source\n *  tree.\n */\n /* eslint-env node */\n'use strict';\nvar logging = require('../utils.js').log;\n\n// Expose public methods.\nmodule.exports = function() {\n  var constraintsToChrome_ = function(c) {\n    if (typeof c !== 'object' || c.mandatory || c.optional) {\n      return c;\n    }\n    var cc = {};\n    Object.keys(c).forEach(function(key) {\n      if (key === 'require' || key === 'advanced' || key === 'mediaSource') {\n        return;\n      }\n      var r = (typeof c[key] === 'object') ? c[key] : {ideal: c[key]};\n      if (r.exact !== undefined && typeof r.exact === 'number') {\n        r.min = r.max = r.exact;\n      }\n      var oldname_ = function(prefix, name) {\n        if (prefix) {\n          return prefix + name.charAt(0).toUpperCase() + name.slice(1);\n        }\n        return (name === 'deviceId') ? 'sourceId' : name;\n      };\n      if (r.ideal !== undefined) {\n        cc.optional = cc.optional || [];\n        var oc = {};\n        if (typeof r.ideal === 'number') {\n          oc[oldname_('min', key)] = r.ideal;\n          cc.optional.push(oc);\n          oc = {};\n          oc[oldname_('max', key)] = r.ideal;\n          cc.optional.push(oc);\n        } else {\n          oc[oldname_('', key)] = r.ideal;\n          cc.optional.push(oc);\n        }\n      }\n      if (r.exact !== undefined && typeof r.exact !== 'number') {\n        cc.mandatory = cc.mandatory || {};\n        cc.mandatory[oldname_('', key)] = r.exact;\n      } else {\n        ['min', 'max'].forEach(function(mix) {\n          if (r[mix] !== undefined) {\n            cc.mandatory = cc.mandatory || {};\n            cc.mandatory[oldname_(mix, key)] = r[mix];\n          }\n        });\n      }\n    });\n    if (c.advanced) {\n      cc.optional = (cc.optional || []).concat(c.advanced);\n    }\n    return cc;\n  };\n\n  var shimConstraints_ = function(constraints, func) {\n    constraints = JSON.parse(JSON.stringify(constraints));\n    if (constraints && constraints.audio) {\n      constraints.audio = constraintsToChrome_(constraints.audio);\n    }\n    if (constraints && typeof constraints.video === 'object') {\n      // Shim facingMode for mobile, where it defaults to \"user\".\n      var face = constraints.video.facingMode;\n      face = face && ((typeof face === 'object') ? face : {ideal: face});\n\n      if ((face && (face.exact === 'user' || face.exact === 'environment' ||\n                    face.ideal === 'user' || face.ideal === 'environment')) &&\n          !(navigator.mediaDevices.getSupportedConstraints &&\n            navigator.mediaDevices.getSupportedConstraints().facingMode)) {\n        delete constraints.video.facingMode;\n        if (face.exact === 'environment' || face.ideal === 'environment') {\n          // Look for \"back\" in label, or use last cam (typically back cam).\n          return navigator.mediaDevices.enumerateDevices()\n          .then(function(devices) {\n            devices = devices.filter(function(d) {\n              return d.kind === 'videoinput';\n            });\n            var back = devices.find(function(d) {\n              return d.label.toLowerCase().indexOf('back') !== -1;\n            }) || (devices.length && devices[devices.length - 1]);\n            if (back) {\n              constraints.video.deviceId = face.exact ? {exact: back.deviceId} :\n                                                        {ideal: back.deviceId};\n            }\n            constraints.video = constraintsToChrome_(constraints.video);\n            logging('chrome: ' + JSON.stringify(constraints));\n            return func(constraints);\n          });\n        }\n      }\n      constraints.video = constraintsToChrome_(constraints.video);\n    }\n    logging('chrome: ' + JSON.stringify(constraints));\n    return func(constraints);\n  };\n\n  var shimError_ = function(e) {\n    return {\n      name: {\n        PermissionDeniedError: 'NotAllowedError',\n        ConstraintNotSatisfiedError: 'OverconstrainedError'\n      }[e.name] || e.name,\n      message: e.message,\n      constraint: e.constraintName,\n      toString: function() {\n        return this.name + (this.message && ': ') + this.message;\n      }\n    };\n  };\n\n  var getUserMedia_ = function(constraints, onSuccess, onError) {\n    shimConstraints_(constraints, function(c) {\n      navigator.webkitGetUserMedia(c, onSuccess, function(e) {\n        onError(shimError_(e));\n      });\n    });\n  };\n\n  navigator.getUserMedia = getUserMedia_;\n\n  // Returns the result of getUserMedia as a Promise.\n  var getUserMediaPromise_ = function(constraints) {\n    return new Promise(function(resolve, reject) {\n      navigator.getUserMedia(constraints, resolve, reject);\n    });\n  };\n\n  if (!navigator.mediaDevices) {\n    navigator.mediaDevices = {\n      getUserMedia: getUserMediaPromise_,\n      enumerateDevices: function() {\n        return new Promise(function(resolve) {\n          var kinds = {audio: 'audioinput', video: 'videoinput'};\n          return MediaStreamTrack.getSources(function(devices) {\n            resolve(devices.map(function(device) {\n              return {label: device.label,\n                      kind: kinds[device.kind],\n                      deviceId: device.id,\n                      groupId: ''};\n            }));\n          });\n        });\n      }\n    };\n  }\n\n  // A shim for getUserMedia method on the mediaDevices object.\n  // TODO(KaptenJansson) remove once implemented in Chrome stable.\n  if (!navigator.mediaDevices.getUserMedia) {\n    navigator.mediaDevices.getUserMedia = function(constraints) {\n      return getUserMediaPromise_(constraints);\n    };\n  } else {\n    // Even though Chrome 45 has navigator.mediaDevices and a getUserMedia\n    // function which returns a Promise, it does not accept spec-style\n    // constraints.\n    var origGetUserMedia = navigator.mediaDevices.getUserMedia.\n        bind(navigator.mediaDevices);\n    navigator.mediaDevices.getUserMedia = function(cs) {\n      return shimConstraints_(cs, function(c) {\n        return origGetUserMedia(c).then(function(stream) {\n          if (c.audio && !stream.getAudioTracks().length ||\n              c.video && !stream.getVideoTracks().length) {\n            stream.getTracks().forEach(function(track) {\n              track.stop();\n            });\n            throw new DOMException('', 'NotFoundError');\n          }\n          return stream;\n        }, function(e) {\n          return Promise.reject(shimError_(e));\n        });\n      });\n    };\n  }\n\n  // Dummy devicechange event methods.\n  // TODO(KaptenJansson) remove once implemented in Chrome stable.\n  if (typeof navigator.mediaDevices.addEventListener === 'undefined') {\n    navigator.mediaDevices.addEventListener = function() {\n      logging('Dummy mediaDevices.addEventListener called.');\n    };\n  }\n  if (typeof navigator.mediaDevices.removeEventListener === 'undefined') {\n    navigator.mediaDevices.removeEventListener = function() {\n      logging('Dummy mediaDevices.removeEventListener called.');\n    };\n  }\n};\n","/*\n *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.\n *\n *  Use of this source code is governed by a BSD-style license\n *  that can be found in the LICENSE file in the root of the source\n *  tree.\n */\n /* eslint-env node */\n'use strict';\n\nvar SDPUtils = require('sdp');\nvar browserDetails = require('../utils').browserDetails;\n\nvar edgeShim = {\n  shimPeerConnection: function() {\n    if (window.RTCIceGatherer) {\n      // ORTC defines an RTCIceCandidate object but no constructor.\n      // Not implemented in Edge.\n      if (!window.RTCIceCandidate) {\n        window.RTCIceCandidate = function(args) {\n          return args;\n        };\n      }\n      // ORTC does not have a session description object but\n      // other browsers (i.e. Chrome) that will support both PC and ORTC\n      // in the future might have this defined already.\n      if (!window.RTCSessionDescription) {\n        window.RTCSessionDescription = function(args) {\n          return args;\n        };\n      }\n      // this adds an additional event listener to MediaStrackTrack that signals\n      // when a tracks enabled property was changed.\n      var origMSTEnabled = Object.getOwnPropertyDescriptor(\n          MediaStreamTrack.prototype, 'enabled');\n      Object.defineProperty(MediaStreamTrack.prototype, 'enabled', {\n        set: function(value) {\n          origMSTEnabled.set.call(this, value);\n          var ev = new Event('enabled');\n          ev.enabled = value;\n          this.dispatchEvent(ev);\n        }\n      });\n    }\n\n    window.RTCPeerConnection = function(config) {\n      var self = this;\n\n      var _eventTarget = document.createDocumentFragment();\n      ['addEventListener', 'removeEventListener', 'dispatchEvent']\n          .forEach(function(method) {\n            self[method] = _eventTarget[method].bind(_eventTarget);\n          });\n\n      this.onicecandidate = null;\n      this.onaddstream = null;\n      this.ontrack = null;\n      this.onremovestream = null;\n      this.onsignalingstatechange = null;\n      this.oniceconnectionstatechange = null;\n      this.onnegotiationneeded = null;\n      this.ondatachannel = null;\n\n      this.localStreams = [];\n      this.remoteStreams = [];\n      this.getLocalStreams = function() {\n        return self.localStreams;\n      };\n      this.getRemoteStreams = function() {\n        return self.remoteStreams;\n      };\n\n      this.localDescription = new RTCSessionDescription({\n        type: '',\n        sdp: ''\n      });\n      this.remoteDescription = new RTCSessionDescription({\n        type: '',\n        sdp: ''\n      });\n      this.signalingState = 'stable';\n      this.iceConnectionState = 'new';\n      this.iceGatheringState = 'new';\n\n      this.iceOptions = {\n        gatherPolicy: 'all',\n        iceServers: []\n      };\n      if (config && config.iceTransportPolicy) {\n        switch (config.iceTransportPolicy) {\n          case 'all':\n          case 'relay':\n            this.iceOptions.gatherPolicy = config.iceTransportPolicy;\n            break;\n          case 'none':\n            // FIXME: remove once implementation and spec have added this.\n            throw new TypeError('iceTransportPolicy \"none\" not supported');\n          default:\n            // don't set iceTransportPolicy.\n            break;\n        }\n      }\n      this.usingBundle = config && config.bundlePolicy === 'max-bundle';\n\n      if (config && config.iceServers) {\n        // Edge does not like\n        // 1) stun:\n        // 2) turn: that does not have all of turn:host:port?transport=udp\n        // 3) turn: with ipv6 addresses\n        var iceServers = JSON.parse(JSON.stringify(config.iceServers));\n        this.iceOptions.iceServers = iceServers.filter(function(server) {\n          if (server && server.urls) {\n            var urls = server.urls;\n            if (typeof urls === 'string') {\n              urls = [urls];\n            }\n            urls = urls.filter(function(url) {\n              return (url.indexOf('turn:') === 0 &&\n                  url.indexOf('transport=udp') !== -1 &&\n                  url.indexOf('turn:[') === -1) ||\n                  (url.indexOf('stun:') === 0 &&\n                    browserDetails.version >= 14393);\n            })[0];\n            return !!urls;\n          }\n          return false;\n        });\n      }\n      this._config = config;\n\n      // per-track iceGathers, iceTransports, dtlsTransports, rtpSenders, ...\n      // everything that is needed to describe a SDP m-line.\n      this.transceivers = [];\n\n      // since the iceGatherer is currently created in createOffer but we\n      // must not emit candidates until after setLocalDescription we buffer\n      // them in this array.\n      this._localIceCandidatesBuffer = [];\n    };\n\n    window.RTCPeerConnection.prototype._emitBufferedCandidates = function() {\n      var self = this;\n      var sections = SDPUtils.splitSections(self.localDescription.sdp);\n      // FIXME: need to apply ice candidates in a way which is async but\n      // in-order\n      this._localIceCandidatesBuffer.forEach(function(event) {\n        var end = !event.candidate || Object.keys(event.candidate).length === 0;\n        if (end) {\n          for (var j = 1; j < sections.length; j++) {\n            if (sections[j].indexOf('\\r\\na=end-of-candidates\\r\\n') === -1) {\n              sections[j] += 'a=end-of-candidates\\r\\n';\n            }\n          }\n        } else if (event.candidate.candidate.indexOf('typ endOfCandidates')\n            === -1) {\n          sections[event.candidate.sdpMLineIndex + 1] +=\n              'a=' + event.candidate.candidate + '\\r\\n';\n        }\n        self.localDescription.sdp = sections.join('');\n        self.dispatchEvent(event);\n        if (self.onicecandidate !== null) {\n          self.onicecandidate(event);\n        }\n        if (!event.candidate && self.iceGatheringState !== 'complete') {\n          var complete = self.transceivers.every(function(transceiver) {\n            return transceiver.iceGatherer &&\n                transceiver.iceGatherer.state === 'completed';\n          });\n          if (complete) {\n            self.iceGatheringState = 'complete';\n          }\n        }\n      });\n      this._localIceCandidatesBuffer = [];\n    };\n\n    window.RTCPeerConnection.prototype.getConfiguration = function() {\n      return this._config;\n    };\n\n    window.RTCPeerConnection.prototype.addStream = function(stream) {\n      // Clone is necessary for local demos mostly, attaching directly\n      // to two different senders does not work (build 10547).\n      var clonedStream = stream.clone();\n      stream.getTracks().forEach(function(track, idx) {\n        var clonedTrack = clonedStream.getTracks()[idx];\n        track.addEventListener('enabled', function(event) {\n          clonedTrack.enabled = event.enabled;\n        });\n      });\n      this.localStreams.push(clonedStream);\n      this._maybeFireNegotiationNeeded();\n    };\n\n    window.RTCPeerConnection.prototype.removeStream = function(stream) {\n      var idx = this.localStreams.indexOf(stream);\n      if (idx > -1) {\n        this.localStreams.splice(idx, 1);\n        this._maybeFireNegotiationNeeded();\n      }\n    };\n\n    window.RTCPeerConnection.prototype.getSenders = function() {\n      return this.transceivers.filter(function(transceiver) {\n        return !!transceiver.rtpSender;\n      })\n      .map(function(transceiver) {\n        return transceiver.rtpSender;\n      });\n    };\n\n    window.RTCPeerConnection.prototype.getReceivers = function() {\n      return this.transceivers.filter(function(transceiver) {\n        return !!transceiver.rtpReceiver;\n      })\n      .map(function(transceiver) {\n        return transceiver.rtpReceiver;\n      });\n    };\n\n    // Determines the intersection of local and remote capabilities.\n    window.RTCPeerConnection.prototype._getCommonCapabilities =\n        function(localCapabilities, remoteCapabilities) {\n          var commonCapabilities = {\n            codecs: [],\n            headerExtensions: [],\n            fecMechanisms: []\n          };\n          localCapabilities.codecs.forEach(function(lCodec) {\n            for (var i = 0; i < remoteCapabilities.codecs.length; i++) {\n              var rCodec = remoteCapabilities.codecs[i];\n              if (lCodec.name.toLowerCase() === rCodec.name.toLowerCase() &&\n                  lCodec.clockRate === rCodec.clockRate) {\n                // number of channels is the highest common number of channels\n                rCodec.numChannels = Math.min(lCodec.numChannels,\n                    rCodec.numChannels);\n                // push rCodec so we reply with offerer payload type\n                commonCapabilities.codecs.push(rCodec);\n\n                // determine common feedback mechanisms\n                rCodec.rtcpFeedback = rCodec.rtcpFeedback.filter(function(fb) {\n                  for (var j = 0; j < lCodec.rtcpFeedback.length; j++) {\n                    if (lCodec.rtcpFeedback[j].type === fb.type &&\n                        lCodec.rtcpFeedback[j].parameter === fb.parameter) {\n                      return true;\n                    }\n                  }\n                  return false;\n                });\n                // FIXME: also need to determine .parameters\n                //  see https://github.com/openpeer/ortc/issues/569\n                break;\n              }\n            }\n          });\n\n          localCapabilities.headerExtensions\n              .forEach(function(lHeaderExtension) {\n                for (var i = 0; i < remoteCapabilities.headerExtensions.length;\n                     i++) {\n                  var rHeaderExtension = remoteCapabilities.headerExtensions[i];\n                  if (lHeaderExtension.uri === rHeaderExtension.uri) {\n                    commonCapabilities.headerExtensions.push(rHeaderExtension);\n                    break;\n                  }\n                }\n              });\n\n          // FIXME: fecMechanisms\n          return commonCapabilities;\n        };\n\n    // Create ICE gatherer, ICE transport and DTLS transport.\n    window.RTCPeerConnection.prototype._createIceAndDtlsTransports =\n        function(mid, sdpMLineIndex) {\n          var self = this;\n          var iceGatherer = new RTCIceGatherer(self.iceOptions);\n          var iceTransport = new RTCIceTransport(iceGatherer);\n          iceGatherer.onlocalcandidate = function(evt) {\n            var event = new Event('icecandidate');\n            event.candidate = {sdpMid: mid, sdpMLineIndex: sdpMLineIndex};\n\n            var cand = evt.candidate;\n            var end = !cand || Object.keys(cand).length === 0;\n            // Edge emits an empty object for RTCIceCandidateComplete\n            if (end) {\n              // polyfill since RTCIceGatherer.state is not implemented in\n              // Edge 10547 yet.\n              if (iceGatherer.state === undefined) {\n                iceGatherer.state = 'completed';\n              }\n\n              // Emit a candidate with type endOfCandidates to make the samples\n              // work. Edge requires addIceCandidate with this empty candidate\n              // to start checking. The real solution is to signal\n              // end-of-candidates to the other side when getting the null\n              // candidate but some apps (like the samples) don't do that.\n              event.candidate.candidate =\n                  'candidate:1 1 udp 1 0.0.0.0 9 typ endOfCandidates';\n            } else {\n              // RTCIceCandidate doesn't have a component, needs to be added\n              cand.component = iceTransport.component === 'RTCP' ? 2 : 1;\n              event.candidate.candidate = SDPUtils.writeCandidate(cand);\n            }\n\n            // update local description.\n            var sections = SDPUtils.splitSections(self.localDescription.sdp);\n            if (event.candidate.candidate.indexOf('typ endOfCandidates')\n                === -1) {\n              sections[event.candidate.sdpMLineIndex + 1] +=\n                  'a=' + event.candidate.candidate + '\\r\\n';\n            } else {\n              sections[event.candidate.sdpMLineIndex + 1] +=\n                  'a=end-of-candidates\\r\\n';\n            }\n            self.localDescription.sdp = sections.join('');\n\n            var complete = self.transceivers.every(function(transceiver) {\n              return transceiver.iceGatherer &&\n                  transceiver.iceGatherer.state === 'completed';\n            });\n\n            // Emit candidate if localDescription is set.\n            // Also emits null candidate when all gatherers are complete.\n            switch (self.iceGatheringState) {\n              case 'new':\n                self._localIceCandidatesBuffer.push(event);\n                if (end && complete) {\n                  self._localIceCandidatesBuffer.push(\n                      new Event('icecandidate'));\n                }\n                break;\n              case 'gathering':\n                self._emitBufferedCandidates();\n                self.dispatchEvent(event);\n                if (self.onicecandidate !== null) {\n                  self.onicecandidate(event);\n                }\n                if (complete) {\n                  self.dispatchEvent(new Event('icecandidate'));\n                  if (self.onicecandidate !== null) {\n                    self.onicecandidate(new Event('icecandidate'));\n                  }\n                  self.iceGatheringState = 'complete';\n                }\n                break;\n              case 'complete':\n                // should not happen... currently!\n                break;\n              default: // no-op.\n                break;\n            }\n          };\n          iceTransport.onicestatechange = function() {\n            self._updateConnectionState();\n          };\n\n          var dtlsTransport = new RTCDtlsTransport(iceTransport);\n          dtlsTransport.ondtlsstatechange = function() {\n            self._updateConnectionState();\n          };\n          dtlsTransport.onerror = function() {\n            // onerror does not set state to failed by itself.\n            dtlsTransport.state = 'failed';\n            self._updateConnectionState();\n          };\n\n          return {\n            iceGatherer: iceGatherer,\n            iceTransport: iceTransport,\n            dtlsTransport: dtlsTransport\n          };\n        };\n\n    // Start the RTP Sender and Receiver for a transceiver.\n    window.RTCPeerConnection.prototype._transceive = function(transceiver,\n        send, recv) {\n      var params = this._getCommonCapabilities(transceiver.localCapabilities,\n          transceiver.remoteCapabilities);\n      if (send && transceiver.rtpSender) {\n        params.encodings = transceiver.sendEncodingParameters;\n        params.rtcp = {\n          cname: SDPUtils.localCName\n        };\n        if (transceiver.recvEncodingParameters.length) {\n          params.rtcp.ssrc = transceiver.recvEncodingParameters[0].ssrc;\n        }\n        transceiver.rtpSender.send(params);\n      }\n      if (recv && transceiver.rtpReceiver) {\n        // remove RTX field in Edge 14942\n        if (transceiver.kind === 'video'\n            && transceiver.recvEncodingParameters) {\n          transceiver.recvEncodingParameters.forEach(function(p) {\n            delete p.rtx;\n          });\n        }\n        params.encodings = transceiver.recvEncodingParameters;\n        params.rtcp = {\n          cname: transceiver.cname\n        };\n        if (transceiver.sendEncodingParameters.length) {\n          params.rtcp.ssrc = transceiver.sendEncodingParameters[0].ssrc;\n        }\n        transceiver.rtpReceiver.receive(params);\n      }\n    };\n\n    window.RTCPeerConnection.prototype.setLocalDescription =\n        function(description) {\n          var self = this;\n          var sections;\n          var sessionpart;\n          if (description.type === 'offer') {\n            // FIXME: What was the purpose of this empty if statement?\n            // if (!this._pendingOffer) {\n            // } else {\n            if (this._pendingOffer) {\n              // VERY limited support for SDP munging. Limited to:\n              // * changing the order of codecs\n              sections = SDPUtils.splitSections(description.sdp);\n              sessionpart = sections.shift();\n              sections.forEach(function(mediaSection, sdpMLineIndex) {\n                var caps = SDPUtils.parseRtpParameters(mediaSection);\n                self._pendingOffer[sdpMLineIndex].localCapabilities = caps;\n              });\n              this.transceivers = this._pendingOffer;\n              delete this._pendingOffer;\n            }\n          } else if (description.type === 'answer') {\n            sections = SDPUtils.splitSections(self.remoteDescription.sdp);\n            sessionpart = sections.shift();\n            var isIceLite = SDPUtils.matchPrefix(sessionpart,\n                'a=ice-lite').length > 0;\n            sections.forEach(function(mediaSection, sdpMLineIndex) {\n              var transceiver = self.transceivers[sdpMLineIndex];\n              var iceGatherer = transceiver.iceGatherer;\n              var iceTransport = transceiver.iceTransport;\n              var dtlsTransport = transceiver.dtlsTransport;\n              var localCapabilities = transceiver.localCapabilities;\n              var remoteCapabilities = transceiver.remoteCapabilities;\n\n              var rejected = mediaSection.split('\\n', 1)[0]\n                  .split(' ', 2)[1] === '0';\n\n              if (!rejected && !transceiver.isDatachannel) {\n                var remoteIceParameters = SDPUtils.getIceParameters(\n                    mediaSection, sessionpart);\n                if (isIceLite) {\n                  var cands = SDPUtils.matchPrefix(mediaSection, 'a=candidate:')\n                  .map(function(cand) {\n                    return SDPUtils.parseCandidate(cand);\n                  })\n                  .filter(function(cand) {\n                    return cand.component === '1';\n                  });\n                  // ice-lite only includes host candidates in the SDP so we can\n                  // use setRemoteCandidates (which implies an\n                  // RTCIceCandidateComplete)\n                  if (cands.length) {\n                    iceTransport.setRemoteCandidates(cands);\n                  }\n                }\n                var remoteDtlsParameters = SDPUtils.getDtlsParameters(\n                    mediaSection, sessionpart);\n                if (isIceLite) {\n                  remoteDtlsParameters.role = 'server';\n                }\n\n                if (!self.usingBundle || sdpMLineIndex === 0) {\n                  iceTransport.start(iceGatherer, remoteIceParameters,\n                      isIceLite ? 'controlling' : 'controlled');\n                  dtlsTransport.start(remoteDtlsParameters);\n                }\n\n                // Calculate intersection of capabilities.\n                var params = self._getCommonCapabilities(localCapabilities,\n                    remoteCapabilities);\n\n                // Start the RTCRtpSender. The RTCRtpReceiver for this\n                // transceiver has already been started in setRemoteDescription.\n                self._transceive(transceiver,\n                    params.codecs.length > 0,\n                    false);\n              }\n            });\n          }\n\n          this.localDescription = {\n            type: description.type,\n            sdp: description.sdp\n          };\n          switch (description.type) {\n            case 'offer':\n              this._updateSignalingState('have-local-offer');\n              break;\n            case 'answer':\n              this._updateSignalingState('stable');\n              break;\n            default:\n              throw new TypeError('unsupported type \"' + description.type +\n                  '\"');\n          }\n\n          // If a success callback was provided, emit ICE candidates after it\n          // has been executed. Otherwise, emit callback after the Promise is\n          // resolved.\n          var hasCallback = arguments.length > 1 &&\n            typeof arguments[1] === 'function';\n          if (hasCallback) {\n            var cb = arguments[1];\n            window.setTimeout(function() {\n              cb();\n              if (self.iceGatheringState === 'new') {\n                self.iceGatheringState = 'gathering';\n              }\n              self._emitBufferedCandidates();\n            }, 0);\n          }\n          var p = Promise.resolve();\n          p.then(function() {\n            if (!hasCallback) {\n              if (self.iceGatheringState === 'new') {\n                self.iceGatheringState = 'gathering';\n              }\n              // Usually candidates will be emitted earlier.\n              window.setTimeout(self._emitBufferedCandidates.bind(self), 500);\n            }\n          });\n          return p;\n        };\n\n    window.RTCPeerConnection.prototype.setRemoteDescription =\n        function(description) {\n          var self = this;\n          var stream = new MediaStream();\n          var receiverList = [];\n          var sections = SDPUtils.splitSections(description.sdp);\n          var sessionpart = sections.shift();\n          var isIceLite = SDPUtils.matchPrefix(sessionpart,\n              'a=ice-lite').length > 0;\n          this.usingBundle = SDPUtils.matchPrefix(sessionpart,\n              'a=group:BUNDLE ').length > 0;\n          sections.forEach(function(mediaSection, sdpMLineIndex) {\n            var lines = SDPUtils.splitLines(mediaSection);\n            var mline = lines[0].substr(2).split(' ');\n            var kind = mline[0];\n            var rejected = mline[1] === '0';\n            var direction = SDPUtils.getDirection(mediaSection, sessionpart);\n\n            var mid = SDPUtils.matchPrefix(mediaSection, 'a=mid:');\n            if (mid.length) {\n              mid = mid[0].substr(6);\n            } else {\n              mid = SDPUtils.generateIdentifier();\n            }\n\n            // Reject datachannels which are not implemented yet.\n            if (kind === 'application' && mline[2] === 'DTLS/SCTP') {\n              self.transceivers[sdpMLineIndex] = {\n                mid: mid,\n                isDatachannel: true\n              };\n              return;\n            }\n\n            var transceiver;\n            var iceGatherer;\n            var iceTransport;\n            var dtlsTransport;\n            var rtpSender;\n            var rtpReceiver;\n            var sendEncodingParameters;\n            var recvEncodingParameters;\n            var localCapabilities;\n\n            var track;\n            // FIXME: ensure the mediaSection has rtcp-mux set.\n            var remoteCapabilities = SDPUtils.parseRtpParameters(mediaSection);\n            var remoteIceParameters;\n            var remoteDtlsParameters;\n            if (!rejected) {\n              remoteIceParameters = SDPUtils.getIceParameters(mediaSection,\n                  sessionpart);\n              remoteDtlsParameters = SDPUtils.getDtlsParameters(mediaSection,\n                  sessionpart);\n              remoteDtlsParameters.role = 'client';\n            }\n            recvEncodingParameters =\n                SDPUtils.parseRtpEncodingParameters(mediaSection);\n\n            var cname;\n            // Gets the first SSRC. Note that with RTX there might be multiple\n            // SSRCs.\n            var remoteSsrc = SDPUtils.matchPrefix(mediaSection, 'a=ssrc:')\n                .map(function(line) {\n                  return SDPUtils.parseSsrcMedia(line);\n                })\n                .filter(function(obj) {\n                  return obj.attribute === 'cname';\n                })[0];\n            if (remoteSsrc) {\n              cname = remoteSsrc.value;\n            }\n\n            var isComplete = SDPUtils.matchPrefix(mediaSection,\n                'a=end-of-candidates', sessionpart).length > 0;\n            var cands = SDPUtils.matchPrefix(mediaSection, 'a=candidate:')\n                .map(function(cand) {\n                  return SDPUtils.parseCandidate(cand);\n                })\n                .filter(function(cand) {\n                  return cand.component === '1';\n                });\n            if (description.type === 'offer' && !rejected) {\n              var transports = self.usingBundle && sdpMLineIndex > 0 ? {\n                iceGatherer: self.transceivers[0].iceGatherer,\n                iceTransport: self.transceivers[0].iceTransport,\n                dtlsTransport: self.transceivers[0].dtlsTransport\n              } : self._createIceAndDtlsTransports(mid, sdpMLineIndex);\n\n              if (isComplete) {\n                transports.iceTransport.setRemoteCandidates(cands);\n              }\n\n              localCapabilities = RTCRtpReceiver.getCapabilities(kind);\n\n              // filter RTX until additional stuff needed for RTX is implemented\n              // in adapter.js\n              localCapabilities.codecs = localCapabilities.codecs.filter(\n                  function(codec) {\n                    return codec.name !== 'rtx';\n                  });\n\n              sendEncodingParameters = [{\n                ssrc: (2 * sdpMLineIndex + 2) * 1001\n              }];\n\n              rtpReceiver = new RTCRtpReceiver(transports.dtlsTransport, kind);\n\n              track = rtpReceiver.track;\n              receiverList.push([track, rtpReceiver]);\n              // FIXME: not correct when there are multiple streams but that is\n              // not currently supported in this shim.\n              stream.addTrack(track);\n\n              // FIXME: look at direction.\n              if (self.localStreams.length > 0 &&\n                  self.localStreams[0].getTracks().length >= sdpMLineIndex) {\n                var localTrack;\n                if (kind === 'audio') {\n                  localTrack = self.localStreams[0].getAudioTracks()[0];\n                } else if (kind === 'video') {\n                  localTrack = self.localStreams[0].getVideoTracks()[0];\n                }\n                if (localTrack) {\n                  rtpSender = new RTCRtpSender(localTrack,\n                      transports.dtlsTransport);\n                }\n              }\n\n              self.transceivers[sdpMLineIndex] = {\n                iceGatherer: transports.iceGatherer,\n                iceTransport: transports.iceTransport,\n                dtlsTransport: transports.dtlsTransport,\n                localCapabilities: localCapabilities,\n                remoteCapabilities: remoteCapabilities,\n                rtpSender: rtpSender,\n                rtpReceiver: rtpReceiver,\n                kind: kind,\n                mid: mid,\n                cname: cname,\n                sendEncodingParameters: sendEncodingParameters,\n                recvEncodingParameters: recvEncodingParameters\n              };\n              // Start the RTCRtpReceiver now. The RTPSender is started in\n              // setLocalDescription.\n              self._transceive(self.transceivers[sdpMLineIndex],\n                  false,\n                  direction === 'sendrecv' || direction === 'sendonly');\n            } else if (description.type === 'answer' && !rejected) {\n              transceiver = self.transceivers[sdpMLineIndex];\n              iceGatherer = transceiver.iceGatherer;\n              iceTransport = transceiver.iceTransport;\n              dtlsTransport = transceiver.dtlsTransport;\n              rtpSender = transceiver.rtpSender;\n              rtpReceiver = transceiver.rtpReceiver;\n              sendEncodingParameters = transceiver.sendEncodingParameters;\n              localCapabilities = transceiver.localCapabilities;\n\n              self.transceivers[sdpMLineIndex].recvEncodingParameters =\n                  recvEncodingParameters;\n              self.transceivers[sdpMLineIndex].remoteCapabilities =\n                  remoteCapabilities;\n              self.transceivers[sdpMLineIndex].cname = cname;\n\n              if ((isIceLite || isComplete) && cands.length) {\n                iceTransport.setRemoteCandidates(cands);\n              }\n              if (!self.usingBundle || sdpMLineIndex === 0) {\n                iceTransport.start(iceGatherer, remoteIceParameters,\n                    'controlling');\n                dtlsTransport.start(remoteDtlsParameters);\n              }\n\n              self._transceive(transceiver,\n                  direction === 'sendrecv' || direction === 'recvonly',\n                  direction === 'sendrecv' || direction === 'sendonly');\n\n              if (rtpReceiver &&\n                  (direction === 'sendrecv' || direction === 'sendonly')) {\n                track = rtpReceiver.track;\n                receiverList.push([track, rtpReceiver]);\n                stream.addTrack(track);\n              } else {\n                // FIXME: actually the receiver should be created later.\n                delete transceiver.rtpReceiver;\n              }\n            }\n          });\n\n          this.remoteDescription = {\n            type: description.type,\n            sdp: description.sdp\n          };\n          switch (description.type) {\n            case 'offer':\n              this._updateSignalingState('have-remote-offer');\n              break;\n            case 'answer':\n              this._updateSignalingState('stable');\n              break;\n            default:\n              throw new TypeError('unsupported type \"' + description.type +\n                  '\"');\n          }\n          if (stream.getTracks().length) {\n            self.remoteStreams.push(stream);\n            window.setTimeout(function() {\n              var event = new Event('addstream');\n              event.stream = stream;\n              self.dispatchEvent(event);\n              if (self.onaddstream !== null) {\n                window.setTimeout(function() {\n                  self.onaddstream(event);\n                }, 0);\n              }\n\n              receiverList.forEach(function(item) {\n                var track = item[0];\n                var receiver = item[1];\n                var trackEvent = new Event('track');\n                trackEvent.track = track;\n                trackEvent.receiver = receiver;\n                trackEvent.streams = [stream];\n                self.dispatchEvent(event);\n                if (self.ontrack !== null) {\n                  window.setTimeout(function() {\n                    self.ontrack(trackEvent);\n                  }, 0);\n                }\n              });\n            }, 0);\n          }\n          if (arguments.length > 1 && typeof arguments[1] === 'function') {\n            window.setTimeout(arguments[1], 0);\n          }\n          return Promise.resolve();\n        };\n\n    window.RTCPeerConnection.prototype.close = function() {\n      this.transceivers.forEach(function(transceiver) {\n        /* not yet\n        if (transceiver.iceGatherer) {\n          transceiver.iceGatherer.close();\n        }\n        */\n        if (transceiver.iceTransport) {\n          transceiver.iceTransport.stop();\n        }\n        if (transceiver.dtlsTransport) {\n          transceiver.dtlsTransport.stop();\n        }\n        if (transceiver.rtpSender) {\n          transceiver.rtpSender.stop();\n        }\n        if (transceiver.rtpReceiver) {\n          transceiver.rtpReceiver.stop();\n        }\n      });\n      // FIXME: clean up tracks, local streams, remote streams, etc\n      this._updateSignalingState('closed');\n    };\n\n    // Update the signaling state.\n    window.RTCPeerConnection.prototype._updateSignalingState =\n        function(newState) {\n          this.signalingState = newState;\n          var event = new Event('signalingstatechange');\n          this.dispatchEvent(event);\n          if (this.onsignalingstatechange !== null) {\n            this.onsignalingstatechange(event);\n          }\n        };\n\n    // Determine whether to fire the negotiationneeded event.\n    window.RTCPeerConnection.prototype._maybeFireNegotiationNeeded =\n        function() {\n          // Fire away (for now).\n          var event = new Event('negotiationneeded');\n          this.dispatchEvent(event);\n          if (this.onnegotiationneeded !== null) {\n            this.onnegotiationneeded(event);\n          }\n        };\n\n    // Update the connection state.\n    window.RTCPeerConnection.prototype._updateConnectionState = function() {\n      var self = this;\n      var newState;\n      var states = {\n        'new': 0,\n        closed: 0,\n        connecting: 0,\n        checking: 0,\n        connected: 0,\n        completed: 0,\n        failed: 0\n      };\n      this.transceivers.forEach(function(transceiver) {\n        states[transceiver.iceTransport.state]++;\n        states[transceiver.dtlsTransport.state]++;\n      });\n      // ICETransport.completed and connected are the same for this purpose.\n      states.connected += states.completed;\n\n      newState = 'new';\n      if (states.failed > 0) {\n        newState = 'failed';\n      } else if (states.connecting > 0 || states.checking > 0) {\n        newState = 'connecting';\n      } else if (states.disconnected > 0) {\n        newState = 'disconnected';\n      } else if (states.new > 0) {\n        newState = 'new';\n      } else if (states.connected > 0 || states.completed > 0) {\n        newState = 'connected';\n      }\n\n      if (newState !== self.iceConnectionState) {\n        self.iceConnectionState = newState;\n        var event = new Event('iceconnectionstatechange');\n        this.dispatchEvent(event);\n        if (this.oniceconnectionstatechange !== null) {\n          this.oniceconnectionstatechange(event);\n        }\n      }\n    };\n\n    window.RTCPeerConnection.prototype.createOffer = function() {\n      var self = this;\n      if (this._pendingOffer) {\n        throw new Error('createOffer called while there is a pending offer.');\n      }\n      var offerOptions;\n      if (arguments.length === 1 && typeof arguments[0] !== 'function') {\n        offerOptions = arguments[0];\n      } else if (arguments.length === 3) {\n        offerOptions = arguments[2];\n      }\n\n      var tracks = [];\n      var numAudioTracks = 0;\n      var numVideoTracks = 0;\n      // Default to sendrecv.\n      if (this.localStreams.length) {\n        numAudioTracks = this.localStreams[0].getAudioTracks().length;\n        numVideoTracks = this.localStreams[0].getVideoTracks().length;\n      }\n      // Determine number of audio and video tracks we need to send/recv.\n      if (offerOptions) {\n        // Reject Chrome legacy constraints.\n        if (offerOptions.mandatory || offerOptions.optional) {\n          throw new TypeError(\n              'Legacy mandatory/optional constraints not supported.');\n        }\n        if (offerOptions.offerToReceiveAudio !== undefined) {\n          numAudioTracks = offerOptions.offerToReceiveAudio;\n        }\n        if (offerOptions.offerToReceiveVideo !== undefined) {\n          numVideoTracks = offerOptions.offerToReceiveVideo;\n        }\n      }\n      if (this.localStreams.length) {\n        // Push local streams.\n        this.localStreams[0].getTracks().forEach(function(track) {\n          tracks.push({\n            kind: track.kind,\n            track: track,\n            wantReceive: track.kind === 'audio' ?\n                numAudioTracks > 0 : numVideoTracks > 0\n          });\n          if (track.kind === 'audio') {\n            numAudioTracks--;\n          } else if (track.kind === 'video') {\n            numVideoTracks--;\n          }\n        });\n      }\n      // Create M-lines for recvonly streams.\n      while (numAudioTracks > 0 || numVideoTracks > 0) {\n        if (numAudioTracks > 0) {\n          tracks.push({\n            kind: 'audio',\n            wantReceive: true\n          });\n          numAudioTracks--;\n        }\n        if (numVideoTracks > 0) {\n          tracks.push({\n            kind: 'video',\n            wantReceive: true\n          });\n          numVideoTracks--;\n        }\n      }\n\n      var sdp = SDPUtils.writeSessionBoilerplate();\n      var transceivers = [];\n      tracks.forEach(function(mline, sdpMLineIndex) {\n        // For each track, create an ice gatherer, ice transport,\n        // dtls transport, potentially rtpsender and rtpreceiver.\n        var track = mline.track;\n        var kind = mline.kind;\n        var mid = SDPUtils.generateIdentifier();\n\n        var transports = self.usingBundle && sdpMLineIndex > 0 ? {\n          iceGatherer: transceivers[0].iceGatherer,\n          iceTransport: transceivers[0].iceTransport,\n          dtlsTransport: transceivers[0].dtlsTransport\n        } : self._createIceAndDtlsTransports(mid, sdpMLineIndex);\n\n        var localCapabilities = RTCRtpSender.getCapabilities(kind);\n        // filter RTX until additional stuff needed for RTX is implemented\n        // in adapter.js\n        localCapabilities.codecs = localCapabilities.codecs.filter(\n            function(codec) {\n              return codec.name !== 'rtx';\n            });\n        localCapabilities.codecs.forEach(function(codec) {\n          // work around https://bugs.chromium.org/p/webrtc/issues/detail?id=6552\n          // by adding level-asymmetry-allowed=1\n          if (codec.name === 'H264' &&\n              codec.parameters['level-asymmetry-allowed'] === undefined) {\n            codec.parameters['level-asymmetry-allowed'] = '1';\n          }\n        });\n\n        var rtpSender;\n        var rtpReceiver;\n\n        // generate an ssrc now, to be used later in rtpSender.send\n        var sendEncodingParameters = [{\n          ssrc: (2 * sdpMLineIndex + 1) * 1001\n        }];\n        if (track) {\n          rtpSender = new RTCRtpSender(track, transports.dtlsTransport);\n        }\n\n        if (mline.wantReceive) {\n          rtpReceiver = new RTCRtpReceiver(transports.dtlsTransport, kind);\n        }\n\n        transceivers[sdpMLineIndex] = {\n          iceGatherer: transports.iceGatherer,\n          iceTransport: transports.iceTransport,\n          dtlsTransport: transports.dtlsTransport,\n          localCapabilities: localCapabilities,\n          remoteCapabilities: null,\n          rtpSender: rtpSender,\n          rtpReceiver: rtpReceiver,\n          kind: kind,\n          mid: mid,\n          sendEncodingParameters: sendEncodingParameters,\n          recvEncodingParameters: null\n        };\n      });\n      if (this.usingBundle) {\n        sdp += 'a=group:BUNDLE ' + transceivers.map(function(t) {\n          return t.mid;\n        }).join(' ') + '\\r\\n';\n      }\n      tracks.forEach(function(mline, sdpMLineIndex) {\n        var transceiver = transceivers[sdpMLineIndex];\n        sdp += SDPUtils.writeMediaSection(transceiver,\n            transceiver.localCapabilities, 'offer', self.localStreams[0]);\n      });\n\n      this._pendingOffer = transceivers;\n      var desc = new RTCSessionDescription({\n        type: 'offer',\n        sdp: sdp\n      });\n      if (arguments.length && typeof arguments[0] === 'function') {\n        window.setTimeout(arguments[0], 0, desc);\n      }\n      return Promise.resolve(desc);\n    };\n\n    window.RTCPeerConnection.prototype.createAnswer = function() {\n      var self = this;\n\n      var sdp = SDPUtils.writeSessionBoilerplate();\n      if (this.usingBundle) {\n        sdp += 'a=group:BUNDLE ' + this.transceivers.map(function(t) {\n          return t.mid;\n        }).join(' ') + '\\r\\n';\n      }\n      this.transceivers.forEach(function(transceiver) {\n        if (transceiver.isDatachannel) {\n          sdp += 'm=application 0 DTLS/SCTP 5000\\r\\n' +\n              'c=IN IP4 0.0.0.0\\r\\n' +\n              'a=mid:' + transceiver.mid + '\\r\\n';\n          return;\n        }\n        // Calculate intersection of capabilities.\n        var commonCapabilities = self._getCommonCapabilities(\n            transceiver.localCapabilities,\n            transceiver.remoteCapabilities);\n\n        sdp += SDPUtils.writeMediaSection(transceiver, commonCapabilities,\n            'answer', self.localStreams[0]);\n      });\n\n      var desc = new RTCSessionDescription({\n        type: 'answer',\n        sdp: sdp\n      });\n      if (arguments.length && typeof arguments[0] === 'function') {\n        window.setTimeout(arguments[0], 0, desc);\n      }\n      return Promise.resolve(desc);\n    };\n\n    window.RTCPeerConnection.prototype.addIceCandidate = function(candidate) {\n      if (!candidate) {\n        this.transceivers.forEach(function(transceiver) {\n          transceiver.iceTransport.addRemoteCandidate({});\n        });\n      } else {\n        var mLineIndex = candidate.sdpMLineIndex;\n        if (candidate.sdpMid) {\n          for (var i = 0; i < this.transceivers.length; i++) {\n            if (this.transceivers[i].mid === candidate.sdpMid) {\n              mLineIndex = i;\n              break;\n            }\n          }\n        }\n        var transceiver = this.transceivers[mLineIndex];\n        if (transceiver) {\n          var cand = Object.keys(candidate.candidate).length > 0 ?\n              SDPUtils.parseCandidate(candidate.candidate) : {};\n          // Ignore Chrome's invalid candidates since Edge does not like them.\n          if (cand.protocol === 'tcp' && (cand.port === 0 || cand.port === 9)) {\n            return;\n          }\n          // Ignore RTCP candidates, we assume RTCP-MUX.\n          if (cand.component !== '1') {\n            return;\n          }\n          // A dirty hack to make samples work.\n          if (cand.type === 'endOfCandidates') {\n            cand = {};\n          }\n          transceiver.iceTransport.addRemoteCandidate(cand);\n\n          // update the remoteDescription.\n          var sections = SDPUtils.splitSections(this.remoteDescription.sdp);\n          sections[mLineIndex + 1] += (cand.type ? candidate.candidate.trim()\n              : 'a=end-of-candidates') + '\\r\\n';\n          this.remoteDescription.sdp = sections.join('');\n        }\n      }\n      if (arguments.length > 1 && typeof arguments[1] === 'function') {\n        window.setTimeout(arguments[1], 0);\n      }\n      return Promise.resolve();\n    };\n\n    window.RTCPeerConnection.prototype.getStats = function() {\n      var promises = [];\n      this.transceivers.forEach(function(transceiver) {\n        ['rtpSender', 'rtpReceiver', 'iceGatherer', 'iceTransport',\n            'dtlsTransport'].forEach(function(method) {\n              if (transceiver[method]) {\n                promises.push(transceiver[method].getStats());\n              }\n            });\n      });\n      var cb = arguments.length > 1 && typeof arguments[1] === 'function' &&\n          arguments[1];\n      return new Promise(function(resolve) {\n        // shim getStats with maplike support\n        var results = new Map();\n        Promise.all(promises).then(function(res) {\n          res.forEach(function(result) {\n            Object.keys(result).forEach(function(id) {\n              results.set(id, result[id]);\n              results[id] = result[id];\n            });\n          });\n          if (cb) {\n            window.setTimeout(cb, 0, results);\n          }\n          resolve(results);\n        });\n      });\n    };\n  }\n};\n\n// Expose public methods.\nmodule.exports = {\n  shimPeerConnection: edgeShim.shimPeerConnection,\n  shimGetUserMedia: require('./getusermedia')\n};\n"," /* eslint-env node */\n'use strict';\n\n// SDP helpers.\nvar SDPUtils = {};\n\n// Generate an alphanumeric identifier for cname or mids.\n// TODO: use UUIDs instead? https://gist.github.com/jed/982883\nSDPUtils.generateIdentifier = function() {\n  return Math.random().toString(36).substr(2, 10);\n};\n\n// The RTCP CNAME used by all peerconnections from the same JS.\nSDPUtils.localCName = SDPUtils.generateIdentifier();\n\n// Splits SDP into lines, dealing with both CRLF and LF.\nSDPUtils.splitLines = function(blob) {\n  return blob.trim().split('\\n').map(function(line) {\n    return line.trim();\n  });\n};\n// Splits SDP into sessionpart and mediasections. Ensures CRLF.\nSDPUtils.splitSections = function(blob) {\n  var parts = blob.split('\\nm=');\n  return parts.map(function(part, index) {\n    return (index > 0 ? 'm=' + part : part).trim() + '\\r\\n';\n  });\n};\n\n// Returns lines that start with a certain prefix.\nSDPUtils.matchPrefix = function(blob, prefix) {\n  return SDPUtils.splitLines(blob).filter(function(line) {\n    return line.indexOf(prefix) === 0;\n  });\n};\n\n// Parses an ICE candidate line. Sample input:\n// candidate:702786350 2 udp 41819902 8.8.8.8 60769 typ relay raddr 8.8.8.8\n// rport 55996\"\nSDPUtils.parseCandidate = function(line) {\n  var parts;\n  // Parse both variants.\n  if (line.indexOf('a=candidate:') === 0) {\n    parts = line.substring(12).split(' ');\n  } else {\n    parts = line.substring(10).split(' ');\n  }\n\n  var candidate = {\n    foundation: parts[0],\n    component: parts[1],\n    protocol: parts[2].toLowerCase(),\n    priority: parseInt(parts[3], 10),\n    ip: parts[4],\n    port: parseInt(parts[5], 10),\n    // skip parts[6] == 'typ'\n    type: parts[7]\n  };\n\n  for (var i = 8; i < parts.length; i += 2) {\n    switch (parts[i]) {\n      case 'raddr':\n        candidate.relatedAddress = parts[i + 1];\n        break;\n      case 'rport':\n        candidate.relatedPort = parseInt(parts[i + 1], 10);\n        break;\n      case 'tcptype':\n        candidate.tcpType = parts[i + 1];\n        break;\n      default: // extension handling, in particular ufrag\n        candidate[parts[i]] = parts[i + 1];\n        break;\n    }\n  }\n  return candidate;\n};\n\n// Translates a candidate object into SDP candidate attribute.\nSDPUtils.writeCandidate = function(candidate) {\n  var sdp = [];\n  sdp.push(candidate.foundation);\n  sdp.push(candidate.component);\n  sdp.push(candidate.protocol.toUpperCase());\n  sdp.push(candidate.priority);\n  sdp.push(candidate.ip);\n  sdp.push(candidate.port);\n\n  var type = candidate.type;\n  sdp.push('typ');\n  sdp.push(type);\n  if (type !== 'host' && candidate.relatedAddress &&\n      candidate.relatedPort) {\n    sdp.push('raddr');\n    sdp.push(candidate.relatedAddress); // was: relAddr\n    sdp.push('rport');\n    sdp.push(candidate.relatedPort); // was: relPort\n  }\n  if (candidate.tcpType && candidate.protocol.toLowerCase() === 'tcp') {\n    sdp.push('tcptype');\n    sdp.push(candidate.tcpType);\n  }\n  return 'candidate:' + sdp.join(' ');\n};\n\n// Parses an ice-options line, returns an array of option tags.\n// a=ice-options:foo bar\nSDPUtils.parseIceOptions = function(line) {\n  return line.substr(14).split(' ');\n}\n\n// Parses an rtpmap line, returns RTCRtpCoddecParameters. Sample input:\n// a=rtpmap:111 opus/48000/2\nSDPUtils.parseRtpMap = function(line) {\n  var parts = line.substr(9).split(' ');\n  var parsed = {\n    payloadType: parseInt(parts.shift(), 10) // was: id\n  };\n\n  parts = parts[0].split('/');\n\n  parsed.name = parts[0];\n  parsed.clockRate = parseInt(parts[1], 10); // was: clockrate\n  // was: channels\n  parsed.numChannels = parts.length === 3 ? parseInt(parts[2], 10) : 1;\n  return parsed;\n};\n\n// Generate an a=rtpmap line from RTCRtpCodecCapability or\n// RTCRtpCodecParameters.\nSDPUtils.writeRtpMap = function(codec) {\n  var pt = codec.payloadType;\n  if (codec.preferredPayloadType !== undefined) {\n    pt = codec.preferredPayloadType;\n  }\n  return 'a=rtpmap:' + pt + ' ' + codec.name + '/' + codec.clockRate +\n      (codec.numChannels !== 1 ? '/' + codec.numChannels : '') + '\\r\\n';\n};\n\n// Parses an a=extmap line (headerextension from RFC 5285). Sample input:\n// a=extmap:2 urn:ietf:params:rtp-hdrext:toffset\n// a=extmap:2/sendonly urn:ietf:params:rtp-hdrext:toffset\nSDPUtils.parseExtmap = function(line) {\n  var parts = line.substr(9).split(' ');\n  return {\n    id: parseInt(parts[0], 10),\n    direction: parts[0].indexOf('/') > 0 ? parts[0].split('/')[1] : 'sendrecv',\n    uri: parts[1]\n  };\n};\n\n// Generates a=extmap line from RTCRtpHeaderExtensionParameters or\n// RTCRtpHeaderExtension.\nSDPUtils.writeExtmap = function(headerExtension) {\n  return 'a=extmap:' + (headerExtension.id || headerExtension.preferredId) +\n      (headerExtension.direction && headerExtension.direction !== 'sendrecv'\n          ? '/' + headerExtension.direction\n          : '') +\n      ' ' + headerExtension.uri + '\\r\\n';\n};\n\n// Parses an ftmp line, returns dictionary. Sample input:\n// a=fmtp:96 vbr=on;cng=on\n// Also deals with vbr=on; cng=on\nSDPUtils.parseFmtp = function(line) {\n  var parsed = {};\n  var kv;\n  var parts = line.substr(line.indexOf(' ') + 1).split(';');\n  for (var j = 0; j < parts.length; j++) {\n    kv = parts[j].trim().split('=');\n    parsed[kv[0].trim()] = kv[1];\n  }\n  return parsed;\n};\n\n// Generates an a=ftmp line from RTCRtpCodecCapability or RTCRtpCodecParameters.\nSDPUtils.writeFmtp = function(codec) {\n  var line = '';\n  var pt = codec.payloadType;\n  if (codec.preferredPayloadType !== undefined) {\n    pt = codec.preferredPayloadType;\n  }\n  if (codec.parameters && Object.keys(codec.parameters).length) {\n    var params = [];\n    Object.keys(codec.parameters).forEach(function(param) {\n      params.push(param + '=' + codec.parameters[param]);\n    });\n    line += 'a=fmtp:' + pt + ' ' + params.join(';') + '\\r\\n';\n  }\n  return line;\n};\n\n// Parses an rtcp-fb line, returns RTCPRtcpFeedback object. Sample input:\n// a=rtcp-fb:98 nack rpsi\nSDPUtils.parseRtcpFb = function(line) {\n  var parts = line.substr(line.indexOf(' ') + 1).split(' ');\n  return {\n    type: parts.shift(),\n    parameter: parts.join(' ')\n  };\n};\n// Generate a=rtcp-fb lines from RTCRtpCodecCapability or RTCRtpCodecParameters.\nSDPUtils.writeRtcpFb = function(codec) {\n  var lines = '';\n  var pt = codec.payloadType;\n  if (codec.preferredPayloadType !== undefined) {\n    pt = codec.preferredPayloadType;\n  }\n  if (codec.rtcpFeedback && codec.rtcpFeedback.length) {\n    // FIXME: special handling for trr-int?\n    codec.rtcpFeedback.forEach(function(fb) {\n      lines += 'a=rtcp-fb:' + pt + ' ' + fb.type +\n      (fb.parameter && fb.parameter.length ? ' ' + fb.parameter : '') +\n          '\\r\\n';\n    });\n  }\n  return lines;\n};\n\n// Parses an RFC 5576 ssrc media attribute. Sample input:\n// a=ssrc:3735928559 cname:something\nSDPUtils.parseSsrcMedia = function(line) {\n  var sp = line.indexOf(' ');\n  var parts = {\n    ssrc: parseInt(line.substr(7, sp - 7), 10)\n  };\n  var colon = line.indexOf(':', sp);\n  if (colon > -1) {\n    parts.attribute = line.substr(sp + 1, colon - sp - 1);\n    parts.value = line.substr(colon + 1);\n  } else {\n    parts.attribute = line.substr(sp + 1);\n  }\n  return parts;\n};\n\n// Extracts the MID (RFC 5888) from a media section.\n// returns the MID or undefined if no mid line was found.\nSDPUtils.getMid = function(mediaSection) {\n  var mid = SDPUtils.matchPrefix(mediaSection, 'a=mid:')[0];\n  if (mid) {\n    return mid.substr(6);\n  }\n}\n\nSDPUtils.parseFingerprint = function(line) {\n  var parts = line.substr(14).split(' ');\n  return {\n    algorithm: parts[0].toLowerCase(), // algorithm is case-sensitive in Edge.\n    value: parts[1]\n  };\n};\n\n// Extracts DTLS parameters from SDP media section or sessionpart.\n// FIXME: for consistency with other functions this should only\n//   get the fingerprint line as input. See also getIceParameters.\nSDPUtils.getDtlsParameters = function(mediaSection, sessionpart) {\n  var lines = SDPUtils.matchPrefix(mediaSection + sessionpart,\n      'a=fingerprint:');\n  // Note: a=setup line is ignored since we use the 'auto' role.\n  // Note2: 'algorithm' is not case sensitive except in Edge.\n  return {\n    role: 'auto',\n    fingerprints: lines.map(SDPUtils.parseFingerprint)\n  };\n};\n\n// Serializes DTLS parameters to SDP.\nSDPUtils.writeDtlsParameters = function(params, setupType) {\n  var sdp = 'a=setup:' + setupType + '\\r\\n';\n  params.fingerprints.forEach(function(fp) {\n    sdp += 'a=fingerprint:' + fp.algorithm + ' ' + fp.value + '\\r\\n';\n  });\n  return sdp;\n};\n// Parses ICE information from SDP media section or sessionpart.\n// FIXME: for consistency with other functions this should only\n//   get the ice-ufrag and ice-pwd lines as input.\nSDPUtils.getIceParameters = function(mediaSection, sessionpart) {\n  var lines = SDPUtils.splitLines(mediaSection);\n  // Search in session part, too.\n  lines = lines.concat(SDPUtils.splitLines(sessionpart));\n  var iceParameters = {\n    usernameFragment: lines.filter(function(line) {\n      return line.indexOf('a=ice-ufrag:') === 0;\n    })[0].substr(12),\n    password: lines.filter(function(line) {\n      return line.indexOf('a=ice-pwd:') === 0;\n    })[0].substr(10)\n  };\n  return iceParameters;\n};\n\n// Serializes ICE parameters to SDP.\nSDPUtils.writeIceParameters = function(params) {\n  return 'a=ice-ufrag:' + params.usernameFragment + '\\r\\n' +\n      'a=ice-pwd:' + params.password + '\\r\\n';\n};\n\n// Parses the SDP media section and returns RTCRtpParameters.\nSDPUtils.parseRtpParameters = function(mediaSection) {\n  var description = {\n    codecs: [],\n    headerExtensions: [],\n    fecMechanisms: [],\n    rtcp: []\n  };\n  var lines = SDPUtils.splitLines(mediaSection);\n  var mline = lines[0].split(' ');\n  for (var i = 3; i < mline.length; i++) { // find all codecs from mline[3..]\n    var pt = mline[i];\n    var rtpmapline = SDPUtils.matchPrefix(\n        mediaSection, 'a=rtpmap:' + pt + ' ')[0];\n    if (rtpmapline) {\n      var codec = SDPUtils.parseRtpMap(rtpmapline);\n      var fmtps = SDPUtils.matchPrefix(\n          mediaSection, 'a=fmtp:' + pt + ' ');\n      // Only the first a=fmtp:<pt> is considered.\n      codec.parameters = fmtps.length ? SDPUtils.parseFmtp(fmtps[0]) : {};\n      codec.rtcpFeedback = SDPUtils.matchPrefix(\n          mediaSection, 'a=rtcp-fb:' + pt + ' ')\n        .map(SDPUtils.parseRtcpFb);\n      description.codecs.push(codec);\n      // parse FEC mechanisms from rtpmap lines.\n      switch (codec.name.toUpperCase()) {\n        case 'RED':\n        case 'ULPFEC':\n          description.fecMechanisms.push(codec.name.toUpperCase());\n          break;\n        default: // only RED and ULPFEC are recognized as FEC mechanisms.\n          break;\n      }\n    }\n  }\n  SDPUtils.matchPrefix(mediaSection, 'a=extmap:').forEach(function(line) {\n    description.headerExtensions.push(SDPUtils.parseExtmap(line));\n  });\n  // FIXME: parse rtcp.\n  return description;\n};\n\n// Generates parts of the SDP media section describing the capabilities /\n// parameters.\nSDPUtils.writeRtpDescription = function(kind, caps) {\n  var sdp = '';\n\n  // Build the mline.\n  sdp += 'm=' + kind + ' ';\n  sdp += caps.codecs.length > 0 ? '9' : '0'; // reject if no codecs.\n  sdp += ' UDP/TLS/RTP/SAVPF ';\n  sdp += caps.codecs.map(function(codec) {\n    if (codec.preferredPayloadType !== undefined) {\n      return codec.preferredPayloadType;\n    }\n    return codec.payloadType;\n  }).join(' ') + '\\r\\n';\n\n  sdp += 'c=IN IP4 0.0.0.0\\r\\n';\n  sdp += 'a=rtcp:9 IN IP4 0.0.0.0\\r\\n';\n\n  // Add a=rtpmap lines for each codec. Also fmtp and rtcp-fb.\n  caps.codecs.forEach(function(codec) {\n    sdp += SDPUtils.writeRtpMap(codec);\n    sdp += SDPUtils.writeFmtp(codec);\n    sdp += SDPUtils.writeRtcpFb(codec);\n  });\n  var maxptime = 0;\n  caps.codecs.forEach(function(codec) {\n    if (codec.maxptime > maxptime) {\n      maxptime = codec.maxptime;\n    }\n  });\n  if (maxptime > 0) {\n    sdp += 'a=maxptime:' + maxptime + '\\r\\n';\n  }\n  sdp += 'a=rtcp-mux\\r\\n';\n\n  caps.headerExtensions.forEach(function(extension) {\n    sdp += SDPUtils.writeExtmap(extension);\n  });\n  // FIXME: write fecMechanisms.\n  return sdp;\n};\n\n// Parses the SDP media section and returns an array of\n// RTCRtpEncodingParameters.\nSDPUtils.parseRtpEncodingParameters = function(mediaSection) {\n  var encodingParameters = [];\n  var description = SDPUtils.parseRtpParameters(mediaSection);\n  var hasRed = description.fecMechanisms.indexOf('RED') !== -1;\n  var hasUlpfec = description.fecMechanisms.indexOf('ULPFEC') !== -1;\n\n  // filter a=ssrc:... cname:, ignore PlanB-msid\n  var ssrcs = SDPUtils.matchPrefix(mediaSection, 'a=ssrc:')\n  .map(function(line) {\n    return SDPUtils.parseSsrcMedia(line);\n  })\n  .filter(function(parts) {\n    return parts.attribute === 'cname';\n  });\n  var primarySsrc = ssrcs.length > 0 && ssrcs[0].ssrc;\n  var secondarySsrc;\n\n  var flows = SDPUtils.matchPrefix(mediaSection, 'a=ssrc-group:FID')\n  .map(function(line) {\n    var parts = line.split(' ');\n    parts.shift();\n    return parts.map(function(part) {\n      return parseInt(part, 10);\n    });\n  });\n  if (flows.length > 0 && flows[0].length > 1 && flows[0][0] === primarySsrc) {\n    secondarySsrc = flows[0][1];\n  }\n\n  description.codecs.forEach(function(codec) {\n    if (codec.name.toUpperCase() === 'RTX' && codec.parameters.apt) {\n      var encParam = {\n        ssrc: primarySsrc,\n        codecPayloadType: parseInt(codec.parameters.apt, 10),\n        rtx: {\n          ssrc: secondarySsrc\n        }\n      };\n      encodingParameters.push(encParam);\n      if (hasRed) {\n        encParam = JSON.parse(JSON.stringify(encParam));\n        encParam.fec = {\n          ssrc: secondarySsrc,\n          mechanism: hasUlpfec ? 'red+ulpfec' : 'red'\n        };\n        encodingParameters.push(encParam);\n      }\n    }\n  });\n  if (encodingParameters.length === 0 && primarySsrc) {\n    encodingParameters.push({\n      ssrc: primarySsrc\n    });\n  }\n\n  // we support both b=AS and b=TIAS but interpret AS as TIAS.\n  var bandwidth = SDPUtils.matchPrefix(mediaSection, 'b=');\n  if (bandwidth.length) {\n    if (bandwidth[0].indexOf('b=TIAS:') === 0) {\n      bandwidth = parseInt(bandwidth[0].substr(7), 10);\n    } else if (bandwidth[0].indexOf('b=AS:') === 0) {\n      bandwidth = parseInt(bandwidth[0].substr(5), 10);\n    }\n    encodingParameters.forEach(function(params) {\n      params.maxBitrate = bandwidth;\n    });\n  }\n  return encodingParameters;\n};\n\n// parses http://draft.ortc.org/#rtcrtcpparameters*\nSDPUtils.parseRtcpParameters = function(mediaSection) {\n  var rtcpParameters = {};\n\n  var cname;\n  // Gets the first SSRC. Note that with RTX there might be multiple\n  // SSRCs.\n  var remoteSsrc = SDPUtils.matchPrefix(mediaSection, 'a=ssrc:')\n      .map(function(line) {\n        return SDPUtils.parseSsrcMedia(line);\n      })\n      .filter(function(obj) {\n        return obj.attribute === 'cname';\n      })[0];\n  if (remoteSsrc) {\n    rtcpParameters.cname = remoteSsrc.value;\n    rtcpParameters.ssrc = remoteSsrc.ssrc;\n  }\n\n  // Edge uses the compound attribute instead of reducedSize\n  // compound is !reducedSize\n  var rsize = SDPUtils.matchPrefix(mediaSection, 'a=rtcp-rsize');\n  rtcpParameters.reducedSize = rsize.length > 0;\n  rtcpParameters.compound = rsize.length === 0;\n\n  // parses the rtcp-mux attrbute.\n  // Note that Edge does not support unmuxed RTCP.\n  var mux = SDPUtils.matchPrefix(mediaSection, 'a=rtcp-mux');\n  rtcpParameters.mux = mux.length > 0;\n\n  return rtcpParameters;\n};\n\n// parses either a=msid: or a=ssrc:... msid lines and returns\n// the id of the MediaStream and MediaStreamTrack.\nSDPUtils.parseMsid = function(mediaSection) {\n  var parts;\n  var spec = SDPUtils.matchPrefix(mediaSection, 'a=msid:');\n  if (spec.length === 1) {\n    parts = spec[0].substr(7).split(' ');\n    return {stream: parts[0], track: parts[1]};\n  }\n  var planB = SDPUtils.matchPrefix(mediaSection, 'a=ssrc:')\n  .map(function(line) {\n    return SDPUtils.parseSsrcMedia(line);\n  })\n  .filter(function(parts) {\n    return parts.attribute === 'msid';\n  });\n  if (planB.length > 0) {\n    parts = planB[0].value.split(' ');\n    return {stream: parts[0], track: parts[1]};\n  }\n};\n\nSDPUtils.writeSessionBoilerplate = function() {\n  // FIXME: sess-id should be an NTP timestamp.\n  return 'v=0\\r\\n' +\n      'o=thisisadapterortc 8169639915646943137 2 IN IP4 127.0.0.1\\r\\n' +\n      's=-\\r\\n' +\n      't=0 0\\r\\n';\n};\n\nSDPUtils.writeMediaSection = function(transceiver, caps, type, stream) {\n  var sdp = SDPUtils.writeRtpDescription(transceiver.kind, caps);\n\n  // Map ICE parameters (ufrag, pwd) to SDP.\n  sdp += SDPUtils.writeIceParameters(\n      transceiver.iceGatherer.getLocalParameters());\n\n  // Map DTLS parameters to SDP.\n  sdp += SDPUtils.writeDtlsParameters(\n      transceiver.dtlsTransport.getLocalParameters(),\n      type === 'offer' ? 'actpass' : 'active');\n\n  sdp += 'a=mid:' + transceiver.mid + '\\r\\n';\n\n  if (transceiver.direction) {\n    sdp += 'a=' + transceiver.direction + '\\r\\n';\n  } else if (transceiver.rtpSender && transceiver.rtpReceiver) {\n    sdp += 'a=sendrecv\\r\\n';\n  } else if (transceiver.rtpSender) {\n    sdp += 'a=sendonly\\r\\n';\n  } else if (transceiver.rtpReceiver) {\n    sdp += 'a=recvonly\\r\\n';\n  } else {\n    sdp += 'a=inactive\\r\\n';\n  }\n\n  if (transceiver.rtpSender) {\n    // spec.\n    var msid = 'msid:' + stream.id + ' ' +\n        transceiver.rtpSender.track.id + '\\r\\n';\n    sdp += 'a=' + msid;\n\n    // for Chrome.\n    sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].ssrc +\n        ' ' + msid;\n    if (transceiver.sendEncodingParameters[0].rtx) {\n      sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].rtx.ssrc +\n          ' ' + msid;\n      sdp += 'a=ssrc-group:FID ' +\n          transceiver.sendEncodingParameters[0].ssrc + ' ' +\n          transceiver.sendEncodingParameters[0].rtx.ssrc +\n          '\\r\\n';\n    }\n  }\n  // FIXME: this should be written by writeRtpDescription.\n  sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].ssrc +\n      ' cname:' + SDPUtils.localCName + '\\r\\n';\n  if (transceiver.rtpSender && transceiver.sendEncodingParameters[0].rtx) {\n    sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].rtx.ssrc +\n        ' cname:' + SDPUtils.localCName + '\\r\\n';\n  }\n  return sdp;\n};\n\n// Gets the direction from the mediaSection or the sessionpart.\nSDPUtils.getDirection = function(mediaSection, sessionpart) {\n  // Look for sendrecv, sendonly, recvonly, inactive, default to sendrecv.\n  var lines = SDPUtils.splitLines(mediaSection);\n  for (var i = 0; i < lines.length; i++) {\n    switch (lines[i]) {\n      case 'a=sendrecv':\n      case 'a=sendonly':\n      case 'a=recvonly':\n      case 'a=inactive':\n        return lines[i].substr(2);\n      default:\n        // FIXME: What should happen here?\n    }\n  }\n  if (sessionpart) {\n    return SDPUtils.getDirection(sessionpart);\n  }\n  return 'sendrecv';\n};\n\nSDPUtils.getKind = function(mediaSection) {\n  var lines = SDPUtils.splitLines(mediaSection);\n  var mline = lines[0].split(' ');\n  return mline[0].substr(2);\n};\n\nSDPUtils.isRejected = function(mediaSection) {\n  return mediaSection.split(' ', 2)[1] === '0';\n};\n\n// Expose public methods.\nmodule.exports = SDPUtils;\n","/*\n *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.\n *\n *  Use of this source code is governed by a BSD-style license\n *  that can be found in the LICENSE file in the root of the source\n *  tree.\n */\n /* eslint-env node */\n'use strict';\n\n// Expose public methods.\nmodule.exports = function() {\n  var shimError_ = function(e) {\n    return {\n      name: {PermissionDeniedError: 'NotAllowedError'}[e.name] || e.name,\n      message: e.message,\n      constraint: e.constraint,\n      toString: function() {\n        return this.name;\n      }\n    };\n  };\n\n  // getUserMedia error shim.\n  var origGetUserMedia = navigator.mediaDevices.getUserMedia.\n      bind(navigator.mediaDevices);\n  navigator.mediaDevices.getUserMedia = function(c) {\n    return origGetUserMedia(c).catch(function(e) {\n      return Promise.reject(shimError_(e));\n    });\n  };\n};\n","/*\n *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.\n *\n *  Use of this source code is governed by a BSD-style license\n *  that can be found in the LICENSE file in the root of the source\n *  tree.\n */\n /* eslint-env node */\n'use strict';\n\nvar browserDetails = require('../utils').browserDetails;\n\nvar firefoxShim = {\n  shimOnTrack: function() {\n    if (typeof window === 'object' && window.RTCPeerConnection && !('ontrack' in\n        window.RTCPeerConnection.prototype)) {\n      Object.defineProperty(window.RTCPeerConnection.prototype, 'ontrack', {\n        get: function() {\n          return this._ontrack;\n        },\n        set: function(f) {\n          if (this._ontrack) {\n            this.removeEventListener('track', this._ontrack);\n            this.removeEventListener('addstream', this._ontrackpoly);\n          }\n          this.addEventListener('track', this._ontrack = f);\n          this.addEventListener('addstream', this._ontrackpoly = function(e) {\n            e.stream.getTracks().forEach(function(track) {\n              var event = new Event('track');\n              event.track = track;\n              event.receiver = {track: track};\n              event.streams = [e.stream];\n              this.dispatchEvent(event);\n            }.bind(this));\n          }.bind(this));\n        }\n      });\n    }\n  },\n\n  shimSourceObject: function() {\n    // Firefox has supported mozSrcObject since FF22, unprefixed in 42.\n    if (typeof window === 'object') {\n      if (window.HTMLMediaElement &&\n        !('srcObject' in window.HTMLMediaElement.prototype)) {\n        // Shim the srcObject property, once, when HTMLMediaElement is found.\n        Object.defineProperty(window.HTMLMediaElement.prototype, 'srcObject', {\n          get: function() {\n            return this.mozSrcObject;\n          },\n          set: function(stream) {\n            this.mozSrcObject = stream;\n          }\n        });\n      }\n    }\n  },\n\n  shimPeerConnection: function() {\n    if (typeof window !== 'object' || !(window.RTCPeerConnection ||\n        window.mozRTCPeerConnection)) {\n      return; // probably media.peerconnection.enabled=false in about:config\n    }\n    // The RTCPeerConnection object.\n    if (!window.RTCPeerConnection) {\n      window.RTCPeerConnection = function(pcConfig, pcConstraints) {\n        if (browserDetails.version < 38) {\n          // .urls is not supported in FF < 38.\n          // create RTCIceServers with a single url.\n          if (pcConfig && pcConfig.iceServers) {\n            var newIceServers = [];\n            for (var i = 0; i < pcConfig.iceServers.length; i++) {\n              var server = pcConfig.iceServers[i];\n              if (server.hasOwnProperty('urls')) {\n                for (var j = 0; j < server.urls.length; j++) {\n                  var newServer = {\n                    url: server.urls[j]\n                  };\n                  if (server.urls[j].indexOf('turn') === 0) {\n                    newServer.username = server.username;\n                    newServer.credential = server.credential;\n                  }\n                  newIceServers.push(newServer);\n                }\n              } else {\n                newIceServers.push(pcConfig.iceServers[i]);\n              }\n            }\n            pcConfig.iceServers = newIceServers;\n          }\n        }\n        return new mozRTCPeerConnection(pcConfig, pcConstraints);\n      };\n      window.RTCPeerConnection.prototype = mozRTCPeerConnection.prototype;\n\n      // wrap static methods. Currently just generateCertificate.\n      if (mozRTCPeerConnection.generateCertificate) {\n        Object.defineProperty(window.RTCPeerConnection, 'generateCertificate', {\n          get: function() {\n            return mozRTCPeerConnection.generateCertificate;\n          }\n        });\n      }\n\n      window.RTCSessionDescription = mozRTCSessionDescription;\n      window.RTCIceCandidate = mozRTCIceCandidate;\n    }\n\n    // shim away need for obsolete RTCIceCandidate/RTCSessionDescription.\n    ['setLocalDescription', 'setRemoteDescription', 'addIceCandidate']\n        .forEach(function(method) {\n          var nativeMethod = RTCPeerConnection.prototype[method];\n          RTCPeerConnection.prototype[method] = function() {\n            arguments[0] = new ((method === 'addIceCandidate') ?\n                RTCIceCandidate : RTCSessionDescription)(arguments[0]);\n            return nativeMethod.apply(this, arguments);\n          };\n        });\n\n    // support for addIceCandidate(null or undefined)\n    var nativeAddIceCandidate =\n        RTCPeerConnection.prototype.addIceCandidate;\n    RTCPeerConnection.prototype.addIceCandidate = function() {\n      if (!arguments[0]) {\n        if (arguments[1]) {\n          arguments[1].apply(null);\n        }\n        return Promise.resolve();\n      }\n      return nativeAddIceCandidate.apply(this, arguments);\n    };\n\n    if (browserDetails.version < 48) {\n      // shim getStats with maplike support\n      var makeMapStats = function(stats) {\n        var map = new Map();\n        Object.keys(stats).forEach(function(key) {\n          map.set(key, stats[key]);\n          map[key] = stats[key];\n        });\n        return map;\n      };\n\n      var nativeGetStats = RTCPeerConnection.prototype.getStats;\n      RTCPeerConnection.prototype.getStats = function(selector, onSucc, onErr) {\n        return nativeGetStats.apply(this, [selector || null])\n          .then(function(stats) {\n            return makeMapStats(stats);\n          })\n          .then(onSucc, onErr);\n      };\n    }\n  }\n};\n\n// Expose public methods.\nmodule.exports = {\n  shimOnTrack: firefoxShim.shimOnTrack,\n  shimSourceObject: firefoxShim.shimSourceObject,\n  shimPeerConnection: firefoxShim.shimPeerConnection,\n  shimGetUserMedia: require('./getusermedia')\n};\n","/*\n *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.\n *\n *  Use of this source code is governed by a BSD-style license\n *  that can be found in the LICENSE file in the root of the source\n *  tree.\n */\n /* eslint-env node */\n'use strict';\n\nvar logging = require('../utils').log;\nvar browserDetails = require('../utils').browserDetails;\n\n// Expose public methods.\nmodule.exports = function() {\n  var shimError_ = function(e) {\n    return {\n      name: {\n        SecurityError: 'NotAllowedError',\n        PermissionDeniedError: 'NotAllowedError'\n      }[e.name] || e.name,\n      message: {\n        'The operation is insecure.': 'The request is not allowed by the ' +\n        'user agent or the platform in the current context.'\n      }[e.message] || e.message,\n      constraint: e.constraint,\n      toString: function() {\n        return this.name + (this.message && ': ') + this.message;\n      }\n    };\n  };\n\n  // getUserMedia constraints shim.\n  var getUserMedia_ = function(constraints, onSuccess, onError) {\n    var constraintsToFF37_ = function(c) {\n      if (typeof c !== 'object' || c.require) {\n        return c;\n      }\n      var require = [];\n      Object.keys(c).forEach(function(key) {\n        if (key === 'require' || key === 'advanced' || key === 'mediaSource') {\n          return;\n        }\n        var r = c[key] = (typeof c[key] === 'object') ?\n            c[key] : {ideal: c[key]};\n        if (r.min !== undefined ||\n            r.max !== undefined || r.exact !== undefined) {\n          require.push(key);\n        }\n        if (r.exact !== undefined) {\n          if (typeof r.exact === 'number') {\n            r. min = r.max = r.exact;\n          } else {\n            c[key] = r.exact;\n          }\n          delete r.exact;\n        }\n        if (r.ideal !== undefined) {\n          c.advanced = c.advanced || [];\n          var oc = {};\n          if (typeof r.ideal === 'number') {\n            oc[key] = {min: r.ideal, max: r.ideal};\n          } else {\n            oc[key] = r.ideal;\n          }\n          c.advanced.push(oc);\n          delete r.ideal;\n          if (!Object.keys(r).length) {\n            delete c[key];\n          }\n        }\n      });\n      if (require.length) {\n        c.require = require;\n      }\n      return c;\n    };\n    constraints = JSON.parse(JSON.stringify(constraints));\n    if (browserDetails.version < 38) {\n      logging('spec: ' + JSON.stringify(constraints));\n      if (constraints.audio) {\n        constraints.audio = constraintsToFF37_(constraints.audio);\n      }\n      if (constraints.video) {\n        constraints.video = constraintsToFF37_(constraints.video);\n      }\n      logging('ff37: ' + JSON.stringify(constraints));\n    }\n    return navigator.mozGetUserMedia(constraints, onSuccess, function(e) {\n      onError(shimError_(e));\n    });\n  };\n\n  // Returns the result of getUserMedia as a Promise.\n  var getUserMediaPromise_ = function(constraints) {\n    return new Promise(function(resolve, reject) {\n      getUserMedia_(constraints, resolve, reject);\n    });\n  };\n\n  // Shim for mediaDevices on older versions.\n  if (!navigator.mediaDevices) {\n    navigator.mediaDevices = {getUserMedia: getUserMediaPromise_,\n      addEventListener: function() { },\n      removeEventListener: function() { }\n    };\n  }\n  navigator.mediaDevices.enumerateDevices =\n      navigator.mediaDevices.enumerateDevices || function() {\n        return new Promise(function(resolve) {\n          var infos = [\n            {kind: 'audioinput', deviceId: 'default', label: '', groupId: ''},\n            {kind: 'videoinput', deviceId: 'default', label: '', groupId: ''}\n          ];\n          resolve(infos);\n        });\n      };\n\n  if (browserDetails.version < 41) {\n    // Work around http://bugzil.la/1169665\n    var orgEnumerateDevices =\n        navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);\n    navigator.mediaDevices.enumerateDevices = function() {\n      return orgEnumerateDevices().then(undefined, function(e) {\n        if (e.name === 'NotFoundError') {\n          return [];\n        }\n        throw e;\n      });\n    };\n  }\n  if (browserDetails.version < 49) {\n    var origGetUserMedia = navigator.mediaDevices.getUserMedia.\n        bind(navigator.mediaDevices);\n    navigator.mediaDevices.getUserMedia = function(c) {\n      return origGetUserMedia(c).then(function(stream) {\n        // Work around https://bugzil.la/802326\n        if (c.audio && !stream.getAudioTracks().length ||\n            c.video && !stream.getVideoTracks().length) {\n          stream.getTracks().forEach(function(track) {\n            track.stop();\n          });\n          throw new DOMException('The object can not be found here.',\n                                 'NotFoundError');\n        }\n        return stream;\n      }, function(e) {\n        return Promise.reject(shimError_(e));\n      });\n    };\n  }\n  navigator.getUserMedia = function(constraints, onSuccess, onError) {\n    if (browserDetails.version < 44) {\n      return getUserMedia_(constraints, onSuccess, onError);\n    }\n    // Replace Firefox 44+'s deprecation warning with unprefixed version.\n    console.warn('navigator.getUserMedia has been replaced by ' +\n                 'navigator.mediaDevices.getUserMedia');\n    navigator.mediaDevices.getUserMedia(constraints).then(onSuccess, onError);\n  };\n};\n","/*\n *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.\n *\n *  Use of this source code is governed by a BSD-style license\n *  that can be found in the LICENSE file in the root of the source\n *  tree.\n */\n'use strict';\nvar safariShim = {\n  // TODO: DrAlex, should be here, double check against LayoutTests\n  // shimOnTrack: function() { },\n\n  // TODO: once the back-end for the mac port is done, add.\n  // TODO: check for webkitGTK+\n  // shimPeerConnection: function() { },\n\n  shimGetUserMedia: function() {\n    navigator.getUserMedia = navigator.webkitGetUserMedia;\n  }\n};\n\n// Expose public methods.\nmodule.exports = {\n  shimGetUserMedia: safariShim.shimGetUserMedia\n  // TODO\n  // shimOnTrack: safariShim.shimOnTrack,\n  // shimPeerConnection: safariShim.shimPeerConnection\n};\n","/*\n *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.\n *\n *  Use of this source code is governed by a BSD-style license\n *  that can be found in the LICENSE file in the root of the source\n *  tree.\n */\n /* eslint-env node */\n\n'use strict';\n\n// Shimming starts here.\n(function() {\n  // Utils.\n  var logging = require('./utils').log;\n  var browserDetails = require('./utils').browserDetails;\n  // Export to the adapter global object visible in the browser.\n  module.exports.browserDetails = browserDetails;\n  module.exports.extractVersion = require('./utils').extractVersion;\n  module.exports.disableLog = require('./utils').disableLog;\n\n  // Uncomment the line below if you want logging to occur, including logging\n  // for the switch statement below. Can also be turned on in the browser via\n  // adapter.disableLog(false), but then logging from the switch statement below\n  // will not appear.\n  // require('./utils').disableLog(false);\n\n  // Browser shims.\n  var chromeShim = require('./chrome/chrome_shim') || null;\n  var edgeShim = require('./edge/edge_shim') || null;\n  var firefoxShim = require('./firefox/firefox_shim') || null;\n  var safariShim = require('./safari/safari_shim') || null;\n\n  // Shim browser if found.\n  switch (browserDetails.browser) {\n    case 'opera': // fallthrough as it uses chrome shims\n    case 'chrome':\n      if (!chromeShim || !chromeShim.shimPeerConnection) {\n        logging('Chrome shim is not included in this adapter release.');\n        return;\n      }\n      logging('adapter.js shimming chrome.');\n      // Export to the adapter global object visible in the browser.\n      module.exports.browserShim = chromeShim;\n\n      chromeShim.shimGetUserMedia();\n      chromeShim.shimMediaStream();\n      chromeShim.shimSourceObject();\n      chromeShim.shimPeerConnection();\n      chromeShim.shimOnTrack();\n      break;\n    case 'firefox':\n      if (!firefoxShim || !firefoxShim.shimPeerConnection) {\n        logging('Firefox shim is not included in this adapter release.');\n        return;\n      }\n      logging('adapter.js shimming firefox.');\n      // Export to the adapter global object visible in the browser.\n      module.exports.browserShim = firefoxShim;\n\n      firefoxShim.shimGetUserMedia();\n      firefoxShim.shimSourceObject();\n      firefoxShim.shimPeerConnection();\n      firefoxShim.shimOnTrack();\n      break;\n    case 'edge':\n      if (!edgeShim || !edgeShim.shimPeerConnection) {\n        logging('MS edge shim is not included in this adapter release.');\n        return;\n      }\n      logging('adapter.js shimming edge.');\n      // Export to the adapter global object visible in the browser.\n      module.exports.browserShim = edgeShim;\n\n      edgeShim.shimGetUserMedia();\n      edgeShim.shimPeerConnection();\n      break;\n    case 'safari':\n      if (!safariShim) {\n        logging('Safari shim is not included in this adapter release.');\n        return;\n      }\n      logging('adapter.js shimming safari.');\n      // Export to the adapter global object visible in the browser.\n      module.exports.browserShim = safariShim;\n\n      safariShim.shimGetUserMedia();\n      break;\n    default:\n      logging('Unsupported browser!');\n  }\n})();\n","// getUserMedia helper by @HenrikJoreteg used for navigator.getUserMedia shim\nvar adapter = require('webrtc-adapter');\n\nmodule.exports = function (constraints, cb) {\n    var error;\n    var haveOpts = arguments.length === 2;\n    var defaultOpts = {video: true, audio: true};\n\n    var denied = 'PermissionDeniedError';\n    var altDenied = 'PERMISSION_DENIED';\n    var notSatisfied = 'ConstraintNotSatisfiedError';\n\n    // make constraints optional\n    if (!haveOpts) {\n        cb = constraints;\n        constraints = defaultOpts;\n    }\n\n    // treat lack of browser support like an error\n    if (typeof navigator === 'undefined' || !navigator.getUserMedia) {\n        // throw proper error per spec\n        error = new Error('MediaStreamError');\n        error.name = 'NotSupportedError';\n\n        // keep all callbacks async\n        return setTimeout(function () {\n            cb(error);\n        }, 0);\n    }\n\n    // normalize error handling when no media types are requested\n    if (!constraints.audio && !constraints.video) {\n        error = new Error('MediaStreamError');\n        error.name = 'NoMediaRequestedError';\n\n        // keep all callbacks async\n        return setTimeout(function () {\n            cb(error);\n        }, 0);\n    }\n\n    navigator.mediaDevices.getUserMedia(constraints)\n    .then(function (stream) {\n        cb(null, stream);\n    }).catch(function (err) {\n        var error;\n        // coerce into an error object since FF gives us a string\n        // there are only two valid names according to the spec\n        // we coerce all non-denied to \"constraint not satisfied\".\n        if (typeof err === 'string') {\n            error = new Error('MediaStreamError');\n            if (err === denied || err === altDenied) {\n                error.name = denied;\n            } else {\n                error.name = notSatisfied;\n            }\n        } else {\n            // if we get an error object make sure '.name' property is set\n            // according to spec: http://dev.w3.org/2011/webrtc/editor/getusermedia.html#navigatorusermediaerror-and-navigatorusermediaerrorcallback\n            error = err;\n            if (!error.name) {\n                // this is likely chrome which\n                // sets a property called \"ERROR_DENIED\" on the error object\n                // if so we make sure to set a name\n                if (error[denied]) {\n                    err.name = denied;\n                } else {\n                    err.name = notSatisfied;\n                }\n            }\n        }\n\n        cb(error);\n    });\n};\n","/**\n * The 3 vertices of a 2D triangle covering the viewport in NDC coordinates ([-1, 1]).\n *\n * @export\n * @type {array.<array.<number>>}\n */\nexport const vertices = [[-1, -1], [-1, 4], [4, -1]];\n\nexport const count = vertices.length;\nexport const dim = 2;\n\n/**\n * The flat array of the above triangle, to be bound as a WebGL attribute buffer for\n * rendering the triangle in the vertex shader.\n * These positions will result in clipped NDC coordinates ([-1, 1]) over the\n * viewport's width and height.\n *\n * @export\n * @type {array.<number>}\n */\nexport const positions = vertices.flat();\n\nexport default positions;\n","/**\n * Creates an iterable array of the given length of empty entries, or\n * those given by optional arguments to `Array.fill`.\n *\n * @see Array.fill\n *\n * @param {number} n The number of elements to create.\n * @param {*} [value] A value to fill the array with; for `Array.fill`.\n * @param {number} [start=0] Start index, inclusive; for `Array.fill`.\n * @param {number} [end=n] End index, exclusive; for `Array.fill`.\n *\n * @returns {array} An array of the given number of empty elements.\n */\nexport const range = (n, value, start, end) => Array(n).fill(value, start, end);\n\nexport default range;\n","const r = Array.prototype.reduce;\n\n/**\n * Reduce an array-like object.\n * Similar to native, but with iteratee-first arguments.\n * Supports the native single-argument behaviour.\n *\n * @param {function} f The iteratee function, given standard arguments, plus the\n *     `out` argument.\n * @param {array} a The list to reduce over (array or array-like object).\n * @param {*} [out] The initial accumulator, if given; otherwise, uses standard\n *     `Array.reduce` behaviour.\n *\n * @returns {*} The result of running the reducer iteratee function over all\n *     elements of the list.\n */\nexport const reduce = (f, a, out) =>\n    // Needs separate `call` because native detects even `undefined` parameter.\n    ((out === undefined)? r.call(a, f) : r.call(a, f, out));\n\nexport default reduce;\n","import { reduce } from './reduce';\n\n/**\n * Map an array-like object.\n * Similar to native, but with iteratee-first arguments; and allows the object\n * into which properties will be mapped to be defined (a new array, by default),\n * avoiding always creating new arrays.\n *\n * @param {function} f The iteratee function, given standard `Array.map`\n *     arguments, plus the output object.\n * @param {array} a The list to map over (array or array-like object).\n * @param {*} [out=[]] The initial accumulator, if given; `a` if falsey given;\n *     or a new array if not given.\n *\n * @returns {*} The result of mapping `out` through the iteratee function over\n *     the `a` list.\n */\nexport const map = (f, a, out = []) => reduce((out, v, i) => {\n        out[i] = f(v, i, a, out);\n\n        return out;\n    },\n    a, (out || a));\n\nexport default map;\n","const e = Array.prototype.forEach;\n\n/**\n * Iterates a function over every element of a list, returning the list.\n *\n * @param {function} f The iteratee function.\n * @param {array} a A list to iterate over (array or array-like object).\n *\n * @returns {array} The given list.\n */\nexport const each = (f, a) => {\n    e.call(a, f);\n\n    return a;\n}\n\nexport default each;\n","/**\n * Wraps an index within a given length, so that indexes greater than the length\n * loop back past 0, and indexes less than 0 loop backward from the length.\n * Similar to the indexing behaviour of `Array.slice`.\n *\n * @param {number} i The index to wrap.\n * @param {number} l The length to wrap the index within.\n *\n * @returns {number} The index wrapped within the length.\n */\nexport const wrapIndex = (i, l) => ((i%l)+l)%l;\n\n/**\n * Gives the entry at a wrapped index of a given list, never exceeds its bounds.\n *\n * @see wrapIndex\n *\n * @param {number} i The index to wrap.\n * @param {array} a A list to index (array or array-like object).\n * @param {number} a.length The length property of the given list.\n *\n * @returns {*} The entry at the wrapped index of the given list.\n */\nexport const wrapGet = (i, a) => a[wrapIndex(i, a.length)];\n\nexport const wrap = { index: wrapIndex, get: wrapGet };\n\nexport default wrap;\n","/**\n * Optical flow fragment shader, for convenience.\n *\n * @see ./index.frag\n */\n\n// #define opticalFlowMap\n\nprecision highp float;\n\nuniform sampler2D next;\nuniform sampler2D past;\nuniform float offset;\nuniform float lambda;\nuniform float alpha;\nuniform vec2 speed;\n\n// Optionally map the flow ([-1, 1]) to a different range (e.g: [0, 1]).\n#ifdef opticalFlowMap\n  uniform vec4 inRange;\n  uniform vec4 outRange;\n\n  #pragma glslify: map = require(glsl-map)\n#endif\n\nvarying vec2 uv;\n\n#pragma glslify: opticalFlow = require(./index)\n\nvoid main() {\n  vec2 flow = opticalFlow(uv, next, past, offset, lambda);\n  float power = dot(flow, flow);\n\n  flow *= speed;\n\n  // Optionally map the flow ([-1, 1]) to a different range (e.g: [0, 1]).\n  #ifdef opticalFlowMap\n    flow = map(flow, inRange.xy, inRange.zw, outRange.xy, outRange.zw);\n  #endif\n\n  gl_FragColor = vec4(flow, power, clamp(power*alpha, 0.0, 1.0));\n}\n","// Perform a `blur`.\n// #define opticalFlowSpreadBlur\n\n// Scale values output by a `tint`.\n// #define opticalFlowSpreadTint\n\n// Shift the sample lookup by a `flow` lookup.\n#define opticalFlowSpreadShift_none 0\n#define opticalFlowSpreadShift_frame 1\n#define opticalFlowSpreadShift_flow 2\n#ifndef opticalFlowSpreadShift\n  #define opticalFlowSpreadShift opticalFlowSpreadShift_none\n#endif\n\n// Map any flow values.\n// #define opticalFlowSpreadMap\n\n// Blend with past frame.\n// #define opticalFlowSpreadBlend\n\nprecision highp float;\n\nuniform sampler2D frame;\n\n// Perform a `blur`.\n#ifdef opticalFlowSpreadBlur\n  uniform vec2 axis;\n  uniform float width;\n  uniform float height;\n#endif\n\n// Alter the values output, scaling by a `tint`.\n#ifdef opticalFlowSpreadTint\n  uniform vec4 tint;\n#endif\n\n#if opticalFlowSpreadShift != opticalFlowSpreadShift_none\n  // Shift the sample lookup by a `flow` lookup.\n  uniform vec2 speed;\n\n  // Use a separate `flow` input.\n  #if opticalFlowSpreadShift == opticalFlowSpreadShift_flow\n    uniform sampler2D flow;\n  #endif\n\n  // Map any flow values.\n  #ifdef opticalFlowSpreadMap\n    uniform vec4 inRange;\n    uniform vec4 toRange;\n\n    #pragma glslify: map = require(glsl-map)\n  #endif\n#endif\n\n#ifdef opticalFlowSpreadBlend\n  uniform sampler2D other;\n  uniform float blend;\n#endif\n\nvarying vec2 uv;\n\n#pragma glslify: blur = require(glsl-fast-gaussian-blur/5)\n\n#if opticalFlowSpreadShift != opticalFlowSpreadShift_none\n  vec2 shift(vec2 uv, sampler2D flow) {\n    vec2 f = texture2D(flow, uv).xy;\n\n    // Reverse any mapping of the flow values.\n    #ifdef opticalFlowSpreadMap\n      f = map(f, toRange.xy, toRange.zw, inRange.xy, inRange.zw);\n    #endif\n\n    return uv+(f*speed);\n  }\n#endif\n\nvoid main() {\n  vec2 st = uv;\n\n  // Shift the sample lookup by a `flow` lookup.\n  #if opticalFlowSpreadShift == opticalFlowSpreadShift_flow\n    // Use the given `flow` input.\n    st = shift(st, flow);\n  #elif opticalFlowSpreadShift == opticalFlowSpreadShift_frame\n    // Use the `frame` itself as `flow` input.\n    st = shift(st, frame);\n  #endif\n\n  // Perform a `blur`.\n  #ifdef opticalFlowSpreadBlur\n    vec4 c = blur(frame, st, vec2(width, height), axis);\n  #else\n    vec4 c = texture2D(frame, st);\n  #endif\n\n  // Map back to any given range.\n  #ifdef opticalFlowSpreadMap\n    c.xy = map(c.xy, toRange.xy, toRange.zw, inRange.xy, inRange.zw);\n  #endif\n\n  // Scale values output by `tint`.\n  #ifdef opticalFlowSpreadTint\n    c *= tint;\n  #endif\n\n  // Reverse any mapping.\n  #ifdef opticalFlowSpreadMap\n    c.xy = map(c.xy, inRange.xy, inRange.zw, toRange.xy, toRange.zw);\n  #endif\n\n  #ifdef opticalFlowSpreadBlend\n    vec4 o = texture2D(other, uv);\n\n    c = mix(c, o, mix(1.0-c.a, o.a, blend));\n  #endif\n\n  gl_FragColor = c;\n}\n","// Map any flow values.\n// #define opticalFlowViewMap\n\nprecision highp float;\n\nuniform sampler2D frame;\n\n// Map any flow values.\n#ifdef opticalFlowViewMap\n  uniform vec4 inRange;\n  uniform vec4 toRange;\n\n  #pragma glslify: map = require(glsl-map)\n#endif\n\nvarying vec2 uv;\n\n#pragma glslify: tau = require(glsl-constants/TWO_PI)\n#pragma glslify: hslToRGB = require(glsl-hsl2rgb)\n\nvoid main() {\n  vec4 data = texture2D(frame, uv);\n  float a = clamp(data.a, 0.0, 1.0);\n  vec2 flow = data.xy;\n\n  // Map any flow values.\n  #ifdef opticalFlowViewMap\n    flow = map(flow, toRange.xy, toRange.zw, inRange.xy, inRange.zw);\n  #endif\n\n  // Angle to hue - red right, green up, cyan left, magenta down.\n  vec3 color = hslToRGB(atan(flow.y, flow.x)/tau, 0.9*a, 0.6*a);\n\n  gl_FragColor = vec4(color, a);\n}\n","/** Any rendering library, but made with `regl` in mind. */\nimport getRegl from 'regl';\nimport getUserMedia from 'getusermedia';\nimport { positions, count } from '@epok.tech/gl-screen-triangle';\nimport range from '@epok.tech/fn-lists/range';\nimport map from '@epok.tech/fn-lists/map';\nimport each from '@epok.tech/fn-lists/each';\nimport { wrapIndex, wrapGet } from '@epok.tech/fn-lists/wrap-index';\n\nimport vert from '@epok.tech/gl-screen-triangle/uv-texture.vert.glsl';\nimport flowFrag from '../index.frag.glsl';\nimport spreadFrag from './spread.frag.glsl';\nimport viewFrag from './view.frag.glsl';\n\nconst demo = document.querySelector('.demo');\nconst video = demo.querySelector('.webcam');\nconst canvas = demo.querySelector('.output');\n\nconst regl = getRegl({\n  canvas,\n  optionalExtensions: [\n    'oes_texture_half_float', 'oes_texture_float', 'oes_texture_float_linear'\n  ]\n});\n\nconst float = (regl.hasExtension('oes_texture_float_linear') &&\n  ((regl.hasExtension('oes_texture_float'))? 'float'\n  : regl.hasExtension('oes_texture_half_float') && 'half float'));\n\n// Whether to remap values between `float`/`int` in textures.\nconst remap = !float;\n\nconst mapProps = { type: float || 'uint8', min: 'linear', mag: 'linear' };\nconst frameProps = { width: 0, height: 0, depth: false, stencil: false };\n\nconst getMap = () => regl.texture(mapProps);\n\nconst getFrame = (color = getMap()) =>\n  regl.framebuffer({ color, ...frameProps });\n\n// Each blur axis of spread.\nconst spreadMaps = map(getMap, range(2), 0);\nconst spreadFrames = map(getFrame, spreadMaps);\n\n// Past and next `video` frames for optical-flow.\nconst flowFrames = map(() => getFrame(), range(2), 0);\nconst flowTo = getFrame();\n\n// Past and next optical-flow frames to blend.\nconst blendFrames = map(() => getFrame(), range(2), 0);\n\nconst resizers = [...spreadFrames, ...flowFrames, flowTo, ...blendFrames];\n\nconst inRange = [-1, -1, 1, 1];\nconst toRange = [0, 0, 1, 1];\n\nconst props = self.opticalFlow = {\n  videoFrame: { data: video, flipY: true },\n  spreadVideo: {\n    /**\n     * Blur the video.\n     *\n     * @see drawSpreadVideoProps\n     */\n    frag: '#define opticalFlowSpreadBlur\\n'+spreadFrag,\n\n    /**\n     * The `passes` props array spreads blur one axis after the other.\n     * Blurs the first axis of the first frame into the next frame, then\n     * the last axis of that frame into the first frame.\n     *\n     * @see drawSpreadProps\n     */\n    passes: map((a, p) => ({ axis: a, pass: p }), [[1.4, 0], [0, 1.4]], 0)\n  },\n  flow: {\n    frag: ((remap)? '#define opticalFlowMap\\n' : '')+flowFrag,\n    // Pixels units; will divide `offset` by the video resolution later.\n    offset: 3, lambda: 1e-3, speed: range(2, 1), alpha: 100,\n    inRange, toRange,\n    to: flowTo\n  },\n  spreadFlow: {\n    /**\n     * Blur the past flow frames along each `axis`, shift/advect along\n     * the `flow` by `speed`, `tint` to weaken the past flow, `blend` in\n     * the next optical-flow frame.\n     *\n     * @see drawSpreadFlowProps\n     */\n    frag: '#define opticalFlowSpreadBlur\\n'+\n      '#define opticalFlowSpreadTint\\n'+\n      '#define opticalFlowSpreadShift opticalFlowSpreadShift_flow\\n'+\n      ((remap)? '#define opticalFlowSpreadMap\\n' : '')+\n      '#define opticalFlowSpreadBlend\\n'+\n      spreadFrag,\n\n    other: flowTo, blend: 1,\n    inRange, toRange,\n\n    /**\n     * Bear in mind each of the `passes` per-`axis` also apply the other\n     * `spread` inputs; some may be better to control per-`pass`, others\n     * across both.\n     *\n     * @see props.spreadVideo.passes\n     */\n    passes: map((o, p) => {\n        o.pass = p;\n\n        return o;\n      },\n      [\n        { axis: [3, 0], tint: range(4, 1), speed: range(2, 0) },\n        { axis: [0, 3], tint: range(4, 0.99), speed: range(2, 1) }\n      ],\n      0)\n  },\n  view: {\n    frag: ((remap)? '#define opticalFlowViewMap\\n' : '')+viewFrag,\n    inRange, toRange\n  }\n};\n\nconst clearView = { color: [0, 0, 0, 1], depth: 1, stencil: 0 };\nconst clearFlow = { ...clearView, framebuffer: flowTo };\n\nconst clearFlows = map((f) => ({ ...clearView, framebuffer: f }), flowFrames);\n\nconst clearSpreads = map((f) => ({ ...clearView, framebuffer: f }),\n  spreadFrames);\n\nconst clearBlends = map((f) => ({ ...clearView, framebuffer: f }), blendFrames);\n\nconst drawScreen = regl({\n  vert, attributes: { position: positions }, count, depth: { enable: false }\n});\n\n// Spread a frame `pass`; blur along an `axis`, shift by a `flow`, `blend`\n// with an `other` map; if given.\nconst drawSpread = regl({\n  frag: (_, p) => p.frag ?? spreadFrag,\n  uniforms: {\n    // Swap by `pass`; allow `frame` to override if given.\n    frame: (_, { pass: p = 0, frame: f }) => f ?? wrapGet(p+1, spreadFrames),\n    axis: regl.prop('axis'),\n    tint: regl.prop('tint'),\n    speed: regl.prop('speed'),\n    flow: regl.prop('flow'),\n    inRange: regl.prop('inRange'),\n    toRange: regl.prop('toRange'),\n    other: regl.prop('other'),\n    blend: regl.prop('blend'),\n    width: regl.context('drawingBufferWidth'),\n    height: regl.context('drawingBufferHeight')\n  },\n  // Swap by `pass`; allow `to` to  override `framebuffer` if given.\n  framebuffer: (_, { pass: p = 0, to }) => to ?? wrapGet(p, spreadFrames)\n});\n\n// Draws the 2 spread blur `passes` across both axes one after the other.\nconst drawSpreadProps = (props) =>\n  // Merge any common `props` into each of `props.passes`.\n  drawSpread(map((pass) => Object.assign(pass, props, pass), props.passes, 0));\n\n// Blur the input video's current frame, into the next flow input frame.\nfunction drawSpreadVideoProps(tick) {\n  const { videoFrame, spreadVideo } = props;\n  const f = wrapIndex(tick, flowFrames.length);\n\n  each(regl.clear, clearSpreads);\n  spreadMaps[1](videoFrame);\n\n  regl.clear(clearFlows[f]);\n  spreadVideo.passes[1].to = flowFrames[f];\n\n  return drawSpreadProps(spreadVideo);\n}\n\n// The main function of concern - optical flow of the last 2 `video` frames.\nconst drawFlow = regl({\n  frag: (_, { frag: f = flowFrag }) => f,\n  uniforms: {\n    next: (c) => wrapGet(c.tick, flowFrames),\n    past: (c) => wrapGet(c.tick+1, flowFrames),\n    offset: regl.prop('offset'),\n    lambda: regl.prop('lambda'),\n    speed: regl.prop('speed'),\n    alpha: regl.prop('alpha'),\n    inRange: regl.prop('inRange'),\n    toRange: regl.prop('toRange')\n  },\n  framebuffer: (_, p) => p.to ?? flowTo\n});\n\nfunction drawFlowProps() {\n  regl.clear(clearFlow);\n\n  return drawFlow(props.flow);\n}\n\n/**\n * Blur the past flow frames along each `axis`, shift/advect along the\n * `flow` by `speed`, `tint` to weaken the past flow, `blend` in the next\n * optical-flow frame.\n *\n * @see props.spreadFlow\n */\nfunction drawSpreadFlowProps(tick) {\n  const { spreadFlow } = props;\n  const { passes } = spreadFlow;\n\n  each(regl.clear, clearSpreads);\n  spreadFlow.flow = passes[0].frame = wrapGet(tick+1, blendFrames);\n\n  const b = wrapIndex(tick, blendFrames.length);\n\n  regl.clear(clearBlends[b]);\n  passes[1].to = blendFrames[b];\n\n  return drawSpreadProps(spreadFlow);\n}\n\n// Draw to the screen.\nconst drawView = regl({\n  frag: (_, p) => p.frag ?? viewFrag,\n  uniforms: {\n    frame: (c) => wrapGet(c.tick, blendFrames),\n    inRange: regl.prop('inRange'),\n    toRange: regl.prop('toRange')\n  },\n  framebuffer: (_, p) => p.to\n});\n\nfunction drawViewProps() {\n  regl.clear(clearView);\n\n  return drawView(props.view);\n}\n\n// All together now.\nfunction draw({ tick: t }) {\n  // Blur the input video's current frame.\n  drawSpreadVideoProps(t);\n  // Get the optical flow from the last 2 `video` frames.\n  drawFlowProps();\n  // Spread the past flow frame and blend with the next one.\n  drawSpreadFlowProps(t);\n  // Draw to the screen.\n  drawViewProps();\n}\n\nfunction setup() {\n  const { videoWidth: w, videoHeight: h } = video;\n\n  video.width = canvas.width = w;\n  video.height = canvas.height = h;\n  each((r) => r.resize(w, h), resizers);\n  // Pixels units; divide `offset` by the video resolution.\n  props.flow.offset /= Math.max(w, h, 1e3);\n  video.play();\n\n  // Fill the flow frames with the first frame.\n  drawScreen(() => {\n    drawSpreadVideoProps(0);\n    drawSpreadVideoProps(1);\n  });\n\n  // Start the main loop.\n  regl.frame(() => drawScreen(draw));\n\n  video.removeEventListener('canplay', setup);\n}\n\nvideo.addEventListener('canplay', setup);\n\ndemo.addEventListener('click', () => {\n  const c = demo.classList;\n\n  c[(c.contains('overlay'))? 'remove' : 'add']('overlay');\n});\n\ngetUserMedia({ video: true }, (e, stream) =>\n  ((e)? console.warn(e)\n  : (('srcObject' in video)? video.srcObject = stream\n  : video.src = URL.createObjectURL(stream))));\n","precision highp float;\n\nattribute vec2 position;\n\nvarying vec2 uv;\n\n// Translation for UV NDC to texture coordinates.\nconst vec2 offset = vec2(0.5);\n\nvoid main() {\n    uv = (position*0.5)+offset;\n    gl_Position = vec4(position, 0, 1);\n}\n"],"names":["$05b9ad2d47b2704e$var$logDisabled_","$05b9ad2d47b2704e$var$utils","disableLog","bool","Error","log","window","console","apply","arguments","extractVersion","uastring","expr","pos","match","length","parseInt","detectBrowser","result","navigator","browser","mozGetUserMedia","version","this","userAgent","webkitGetUserMedia","webkitRTCPeerConnection","mediaDevices","module","exports","browserDetails","$739dc659352c0940$var$chromeShim","shimMediaStream","MediaStream","webkitMediaStream","shimOnTrack","RTCPeerConnection","prototype","Object","defineProperty","get","_ontrack","set","f","self","removeEventListener","_ontrackpoly","addEventListener","e","stream","te","event","Event","track","receiver","streams","dispatchEvent","getTracks","forEach","bind","shimSourceObject","HTMLMediaElement","_srcObject","src","URL","revokeObjectURL","createObjectURL","shimPeerConnection","pcConfig","pcConstraints","iceTransportPolicy","iceTransports","pc","origGetStats","getStats","selector","successCallback","errorCallback","args","fixChromeStats_","response","standardReport","report","standardStats","id","timestamp","type","names","name","stat","makeMapStats","stats","legacyStats","map","Map","keys","key","successCallbackWrapper_","Promise","resolve","reject","then","generateCertificate","method","nativeMethod","opts","undefined","$739dc659352c0940$require$browserDetails","promise","err","RTCIceCandidate","RTCSessionDescription","nativeAddIceCandidate","addIceCandidate","shimGetUserMedia","parcelRequire","constraintsToChrome_","c","mandatory","optional","cc","r","ideal","exact","min","max","oldname_","prefix","charAt","toUpperCase","slice","oc","push","mix","advanced","concat","shimConstraints_","constraints","func","JSON","parse","stringify","audio","video","face","facingMode","getSupportedConstraints","enumerateDevices","devices","back","filter","d","kind","find","label","toLowerCase","indexOf","deviceId","shimError_","PermissionDeniedError","ConstraintNotSatisfiedError","message","constraint","constraintName","toString","getUserMedia","onSuccess","onError","getUserMediaPromise_","kinds","MediaStreamTrack","getSources","device","groupId","origGetUserMedia","cs","getAudioTracks","getVideoTracks","stop","DOMException","$c7437094663cda46$var$edgeShim","RTCIceGatherer","origMSTEnabled","getOwnPropertyDescriptor","value","call","ev","enabled","config","_eventTarget","document","createDocumentFragment","onicecandidate","onaddstream","ontrack","onremovestream","onsignalingstatechange","oniceconnectionstatechange","onnegotiationneeded","ondatachannel","localStreams","remoteStreams","getLocalStreams","getRemoteStreams","localDescription","sdp","remoteDescription","signalingState","iceConnectionState","iceGatheringState","iceOptions","gatherPolicy","iceServers","TypeError","usingBundle","bundlePolicy","server","urls","url","$c7437094663cda46$require$browserDetails","_config","transceivers","_localIceCandidatesBuffer","_emitBufferedCandidates","sections","$eljpv","splitSections","candidate","j","sdpMLineIndex","join","every","transceiver","iceGatherer","state","getConfiguration","addStream","clonedStream","clone","idx","clonedTrack","_maybeFireNegotiationNeeded","removeStream","splice","getSenders","rtpSender","getReceivers","rtpReceiver","_getCommonCapabilities","localCapabilities","remoteCapabilities","commonCapabilities","codecs","headerExtensions","fecMechanisms","lCodec","i","rCodec","clockRate","numChannels","Math","rtcpFeedback","fb","parameter","lHeaderExtension","rHeaderExtension","uri","_createIceAndDtlsTransports","mid","iceTransport","RTCIceTransport","onlocalcandidate","evt","sdpMid","cand","end","component","writeCandidate","complete","onicestatechange","_updateConnectionState","dtlsTransport","RTCDtlsTransport","ondtlsstatechange","onerror","_transceive","send","recv","params","encodings","sendEncodingParameters","rtcp","cname","localCName","recvEncodingParameters","ssrc","p","rtx","receive","setLocalDescription","description","sessionpart","_pendingOffer","shift","mediaSection","caps","parseRtpParameters","isIceLite","matchPrefix","split","isDatachannel","remoteIceParameters","getIceParameters","cands","parseCandidate","setRemoteCandidates","remoteDtlsParameters","getDtlsParameters","role","start","_updateSignalingState","hasCallback","cb","setTimeout","setRemoteDescription","receiverList","mline","splitLines","substr","rejected","direction","getDirection","generateIdentifier","parseRtpEncodingParameters","remoteSsrc","line","parseSsrcMedia","obj","attribute","isComplete","addTrack","localTrack","transports","RTCRtpReceiver","getCapabilities","codec","RTCRtpSender","item","trackEvent","close","newState","states","new","closed","connecting","checking","connected","completed","failed","disconnected","createOffer","offerOptions","tracks","numAudioTracks","numVideoTracks","offerToReceiveAudio","offerToReceiveVideo","wantReceive","writeSessionBoilerplate","parameters","t","writeMediaSection","desc","createAnswer","mLineIndex","transceiver1","protocol","port","addRemoteCandidate","trim","promises","results","all","res","$a712155e36331508$var$SDPUtils","random","blob","part","index","parts","foundation","substring","priority","ip","relatedAddress","relatedPort","tcpType","parseIceOptions","parseRtpMap","parsed","payloadType","writeRtpMap","pt","preferredPayloadType","parseExtmap","writeExtmap","headerExtension","preferredId","parseFmtp","kv","writeFmtp","param","parseRtcpFb","writeRtcpFb","lines","sp","colon","getMid","parseFingerprint","algorithm","fingerprints","writeDtlsParameters","setupType","fp","usernameFragment","password","writeIceParameters","rtpmapline","fmtps","writeRtpDescription","maxptime","extension","secondarySsrc","encodingParameters","hasRed","hasUlpfec","ssrcs","primarySsrc","flows","apt","encParam","codecPayloadType","fec","mechanism","bandwidth","maxBitrate","parseRtcpParameters","rtcpParameters","rsize","reducedSize","compound","mux","parseMsid","parts1","spec","planB","getLocalParameters","msid","getKind","isRejected","catch","$2ac3825dde846770$var$firefoxShim","mozSrcObject","mozRTCPeerConnection","$2ac3825dde846770$require$browserDetails","newIceServers","hasOwnProperty","newServer","username","credential","mozRTCSessionDescription","mozRTCIceCandidate","nativeGetStats","onSucc","onErr","SecurityError","getUserMedia_","constraintsToFF37_","require","$094cb62859ffbce3$require$browserDetails","orgEnumerateDevices","warn","$4ca985779406f9e8$var$safariShim","logging","chromeShim","edgeShim","firefoxShim","safariShim","$ca190db2c22902b2$exports","error1","haveOpts","defaultOpts","denied","altDenied","notSatisfied","error","$8cca7dd78c4331af$export$ba60520149d1328e","$8cca7dd78c4331af$export$85b9a36db797e02b","$8cca7dd78c4331af$export$878041e1e4cd4218","flat","$14f586be6fb44fe8$export$2e2bcd8739ae039","n","Array","fill","$3ff2f9e4ab7bdeff$var$r","reduce","$3ff2f9e4ab7bdeff$export$533b26079ad0b4b","a","out","$f132d33d57f1bee8$export$2e2bcd8739ae039","out1","v","$3846eaa2ea51626f$var$e","$3846eaa2ea51626f$export$2e2bcd8739ae039","$df9d8a68b07f20b6$export$acb6ab09ed1b7b8b","l","$df9d8a68b07f20b6$export$ea134dcc07e79c49","$73a0c5655b995c2c$exports","$8ca505ed01838cb3$exports","$841293370bd7b3ef$exports","$cbe77ee65be13eb6$var$demo","querySelector","$cbe77ee65be13eb6$var$video","$cbe77ee65be13eb6$var$canvas","$cbe77ee65be13eb6$var$regl","$parcel$interopDefault","$9acea99a8bf860b0$exports","optionalExtensions","$cbe77ee65be13eb6$var$float","hasExtension","$cbe77ee65be13eb6$var$remap","$cbe77ee65be13eb6$var$mapProps","mag","$cbe77ee65be13eb6$var$frameProps","width","height","depth","stencil","$cbe77ee65be13eb6$var$getMap","texture","$cbe77ee65be13eb6$var$getFrame","color","framebuffer","$cbe77ee65be13eb6$var$spreadMaps","$cbe77ee65be13eb6$var$spreadFrames","$cbe77ee65be13eb6$var$flowFrames","$cbe77ee65be13eb6$var$flowTo","$cbe77ee65be13eb6$var$blendFrames","$cbe77ee65be13eb6$var$resizers","$cbe77ee65be13eb6$var$inRange","$cbe77ee65be13eb6$var$toRange","$cbe77ee65be13eb6$var$props","opticalFlow","videoFrame","data","flipY","spreadVideo","frag","passes","axis","pass","flow","offset","lambda","speed","alpha","to","spreadFlow","other","blend","o","tint","view","$cbe77ee65be13eb6$var$clearView","$cbe77ee65be13eb6$var$clearFlow","$cbe77ee65be13eb6$var$clearFlows","$cbe77ee65be13eb6$var$clearSpreads","$cbe77ee65be13eb6$var$clearBlends","$cbe77ee65be13eb6$var$drawScreen","attributes","position","enable","_frag","$cbe77ee65be13eb6$var$drawSpread","_","uniforms","frame","prop","inRange","toRange","context","$cbe77ee65be13eb6$var$drawSpreadProps","props","assign","$cbe77ee65be13eb6$var$drawSpreadVideoProps","tick","clear","_to","$cbe77ee65be13eb6$var$drawFlow","next","past","_frag1","$cbe77ee65be13eb6$var$drawView","$cbe77ee65be13eb6$var$draw","b","$cbe77ee65be13eb6$var$drawSpreadFlowProps","$cbe77ee65be13eb6$var$setup","videoWidth","w","videoHeight","h","resize","play","classList","contains","srcObject"],"version":3,"file":"index.3682d95f.js.map"}